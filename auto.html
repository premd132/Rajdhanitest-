<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Automatic Photo Pattern Engine</title>
<style>
body{font-family:Arial;background:#f6f1d3;padding:10px}
table{border-collapse:collapse}
td{
  border:1px solid #999;
  width:55px;height:32px;
  text-align:center;
  font-weight:700;
  background:#fbf6db;
  position:relative;
}
.square{outline:3px solid #000}
.circle{border:3px solid blue;border-radius:50%}
svg{position:absolute;top:0;left:0;pointer-events:none}
</style>
</head>
<body>

Day:
<select id="day">
<option value="0">Mon</option>
<option value="1">Tue</option>
<option value="2">Wed</option>
<option value="3">Thu</option>
<option value="4">Fri</option>
<option value="5">Sat</option>
</select>

Base:
<input id="base" value="20" size="3">

Rows:
<select id="rows">
<option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
</select>

<input type="file" id="csv">
<button onclick="upload()">Upload</button>
<button onclick="search()">SEARCH</button>

<div style="position:relative">
<svg id="lines"></svg>
<table id="tbl"></table>
</div>

<script>
// ---------- FAMILY ----------
const FAMILIES={
"25":["02","07","20","25","52","57","70","75"],
"15":["01","06","10","15","51","56","60","65"],
"full":["00","11","22","33","44","55","66","77","88","99"]
};

// ---------- UTIL ----------
const pad=v=>{
 if(v==="**") return "**";
 v=String(v).replace(/\D/g,"");
 if(v==="") return "**";
 return v.length===1?"0"+v:v.slice(-2);
};
const palti=v=>v[1]+v[0];
const familyOf=v=>{
 for(let k in FAMILIES) if(FAMILIES[k].includes(v)) return k;
 return null;
};
const match=(base,v)=>{
 if(v==="**") return false;
 if(v===base) return true;
 if(palti(v)===base) return true;
 let f=familyOf(base);
 return f && FAMILIES[f].includes(v);
};

// ---------- DATA ----------
let data=[];

// ---------- CSV ----------
function upload(){
 const f=csv.files[0];
 if(!f) return;
 const r=new FileReader();
 r.onload=()=>{
  data=r.result.trim().split(/\n/).map(l=>{
    let p=l.split(".");
    let row=["**","**","**","**","**","**"];
    if(p.length===1){
      row[day.value]=pad(p[0]);
    }else{
      for(let i=0;i<6;i++) row[i]=pad(p[i]||"**");
    }
    return row;
  });
  draw();
 };
 r.readAsText(f);
}

// ---------- DRAW ----------
function draw(){
 tbl.innerHTML="";
 data.forEach((r,ri)=>{
  let tr=document.createElement("tr");
  r.forEach((v,ci)=>{
    let td=document.createElement("td");
    td.textContent=v;
    td.dataset.r=ri;td.dataset.c=ci;
    tr.appendChild(td);
  });
  tbl.appendChild(tr);
 });
}

// ---------- AUTO ENGINE ----------
function search(){
 clear();
 let base=pad(baseInput.value);
 let col=parseInt(day.value);
 let max=parseInt(rows.value);

 // bottom-up scan
 for(let r=data.length-1;r>=0;r--){
  if(data[r][col]===base){
    markSquare(r,col);
    generatePatterns(r,col,base,max);
  }
 }
}

// ---------- PATTERN GENERATOR ----------
const MOVES=[
 {dr:-1,dc:0},{dr:-1,dc:-1},{dr:-1,dc:1}
];

function generatePatterns(br,bc,base,max){
 function dfs(path,r,c,depth){
  if(depth>=max) return;
  for(let m of MOVES){
    let nr=r+m.dr,nc=c+m.dc;
    if(nr<0||nc<0||nc>=6) continue;
    let v=data[nr][nc];
    if(match(base,v)){
      path.push({r:nr,c:nc});
      if(path.length>=2){
        drawPath(path);
      }
      dfs(path,nr,nc,depth+1);
      path.pop();
    }
  }
 }
 dfs([],br,bc,0);
}

// ---------- MARK ----------
function cell(r,c){
 return document.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
}
function markSquare(r,c){cell(r,c).classList.add("square")}
function markCircle(r,c){cell(r,c).classList.add("circle")}

function drawPath(p){
 p.forEach(pt=>markCircle(pt.r,pt.c));
 for(let i=0;i<p.length-1;i++){
  let a=cell(p[i].r,p[i].c).getBoundingClientRect();
  let b=cell(p[i+1].r,p[i+1].c).getBoundingClientRect();
  let box=lines.getBoundingClientRect();
  let l=document.createElementNS("http://www.w3.org/2000/svg","line");
  l.setAttribute("x1",a.left+a.width/2-box.left);
  l.setAttribute("y1",a.top+a.height/2-box.top);
  l.setAttribute("x2",b.left+b.width/2-box.left);
  l.setAttribute("y2",b.top+b.height/2-box.top);
  l.setAttribute("stroke","blue");
  l.setAttribute("stroke-width","2");
  lines.appendChild(l);
 }
}

// ---------- CLEAR ----------
function clear(){
 document.querySelectorAll(".square,.circle").forEach(e=>{
  e.classList.remove("square","circle");
 });
 lines.innerHTML="";
}
</script>
</body>
</html>
