<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rajdhani – AI Multi-Pattern System</title>
<style>
    :root { --gold: #ffd700; --bg: #121212; --panel: #1e1e1e; }
    body { font-family: 'Segoe UI', Arial; background: var(--bg); color: #fff; margin: 0; padding: 10px; }
    
    h2 { color: var(--gold); text-align: center; text-transform: uppercase; font-size: 1.1rem; margin-bottom: 10px; }
    
    .toolbar { background: var(--panel); padding: 10px; border-radius: 8px; border: 1px solid #444; margin-bottom: 10px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    
    table { border-collapse: collapse; font-size: 12px; background: #fff; color: #000; width: 100%; max-width: 600px; margin: 0 auto; table-layout: fixed; }
    td, th { border: 1px solid #999; padding: 6px 2px; text-align: center; font-weight: bold; height: 32px; overflow: hidden; }
    th { background: #444; color: white; }
    
    /* Marking Styles */
    .match-circle { border: 2px solid #ff3e3e; border-radius: 50%; background: rgba(255, 62, 62, 0.2); }
    .base-highlight { background: #ffff00 !important; color: #000; border: 2px solid #000; }
    
    /* Family Colors for visual distinction */
    .f-color-1 { background: #e3f2fd; } .f-color-2 { background: #f1f8e9; }
    .f-color-3 { background: #fff3e0; } .f-color-4 { background: #f3e5f5; }

    .card { background: var(--panel); padding: 10px; border-radius: 8px; border-left: 4px solid var(--gold); margin-top: 10px; }
    #checks div { background: #2a2a2a; margin: 5px 0; padding: 10px; cursor: pointer; border-radius: 4px; border: 1px solid #444; }
    
    #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border: 4px solid var(--gold); display: none; z-index: 100; padding: 10px; border-radius: 8px; color: #000; width: 95%; max-width: 500px; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 90; }
    
    button { background: var(--gold); color: #000; border: none; padding: 8px 15px; font-weight: bold; border-radius: 4px; cursor: pointer; }
    .blank { cursor: pointer; color: #bbb; background: #eee; }
</style>
</head>
<body>

<h2>test – Multi-Family Pattern</h2>

<div class="toolbar">
    <input type="file" id="csv" accept=".csv">
    <button onclick="addRow()">+ Row</button>
    <button onclick="saveData()">Save</button>
</div>

<table id="tbl"></table>

<div class="card">
    <h3 style="margin:0; font-size:14px; color:var(--gold)">Strong Line Matches</h3>
    <div id="checks">Click any cell to start search</div>
</div>

<div class="card">
    <h3 style="margin:0; font-size:14px; color:var(--gold)">AI Future (Next Day)</h3>
    <div id="future">---</div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <h4 style="margin:0 0 10px 0">Pattern Preview <button onclick="closePopup()" style="float:right">X</button></h4>
    <div id="popData"></div>
</div>

<script>
const STORAGE_KEY = "pdata_test_v2";
let targetCol = null, activeMark = null, lastMatches = [], topMatches = [];

// Full Family Database
const families = {
    "11":["11","16","61","66"],"22":["22","27","72","77"],"33":["33","38","83","88"],"44":["44","49","94","99"],"55":["00","05","50","55"],
    "12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],
    "15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],
    "25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],
    "45":["04","09","40","45","54","59","90","95"]
};

function fam(v) { for(let k in families) if(families[k].includes(v)) return k; return null; }
function norm(v) { 
    if(!v || v=="" || v=="**" || v=="*") return "**"; 
    let s = String(v).trim().replace(/[^0-9]/g, '');
    if(s.length == 1) s = "0" + s;
    return s.length == 2 ? s : "**";
}

let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
    ["51","91","41","57","19","95"],["05","90","74","06","19","63"],["90","34","82","09","28","19"],["**","**","**","**","**","**"]
];
data = data.map(r => r.map(norm));

function draw() {
    let h = "<tr><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>";
    data.forEach((r, ri) => {
        h += "<tr>";
        r.forEach((c, ci) => {
            let cls = (c == "**") ? "blank" : "";
            if(activeMark) {
                let {start, template} = activeMark;
                let relR = ri - start;
                if(relR >= 0 && relR < template.length && template[relR][ci]) {
                    cls += " match-circle";
                }
            }
            h += `<td class="${cls}" contenteditable="true" onblur="updateCell(${ri},${ci},this.innerText)" onclick="makeMultiPattern(${ri},${ci})">${c}</td>`;
        });
        h += "</tr>";
    });
    document.getElementById("tbl").innerHTML = h;
}

function updateCell(r, c, val) {
    data[r][c] = norm(val);
    draw();
}

function addRow() { data.push(["**","**","**","**","**","**"]); draw(); }
function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); alert("Data Saved!"); }

// CSV Logic
document.getElementById("csv").onchange = e => {
    let reader = new FileReader();
    reader.onload = (ev) => {
        let rows = ev.target.result.split("\n");
        data = rows.filter(row => row.trim() != "").map(row => row.split(",").map(v => norm(v)));
        draw();
    };
    reader.readAsText(e.target.files[0]);
};

// ADVANCED SEARCH LOGIC
function makeMultiPattern(r, c) {
    targetCol = c;
    // Hum pichle 5 rows ka "Family Map" banate hain
    let template = [];
    let baseRows = 5;
    let startRow = Math.max(0, r - baseRows);
    
    for(let i = startRow; i < r; i++) {
        let rowMap = [];
        for(let j = 0; j < 6; j++) {
            let val = data[i][j];
            rowMap.push(val === "**" ? null : fam(val));
        }
        template.push(rowMap);
    }
    
    searchMultiFamily(template);
}

function searchMultiFamily(template) {
    lastMatches = [];
    let h = template.length;
    
    // Pure data mein ye template dhundna
    for(let i = 0; i <= data.length - h - 1; i++) {
        let matchCount = 0;
        let totalRequired = 0;
        
        for(let k = 0; k < h; k++) {
            for(let j = 0; j < 6; j++) {
                if(template[k][j]) {
                    totalRequired++;
                    if(fam(data[i+k][j]) === template[k][j]) matchCount++;
                }
            }
        }
        
        // Agar saari families apni jagah par hain (Majboot Pattern)
        if(totalRequired > 0 && matchCount === totalRequired) {
            lastMatches.push({index: i});
        }
    }
    showResults(template);
}

function showResults(template) {
    let div = document.getElementById("checks");
    div.innerHTML = "";
    if(lastMatches.length == 0) { div.innerHTML = "No identical family pattern found."; return; }
    
    topMatches = lastMatches.slice(-4); 
    topMatches.forEach((m, i) => {
        let d = document.createElement("div");
        d.innerHTML = `<b>Pattern Match #${i+1}</b> - Starts at Row ${m.index+1}`;
        d.onclick = () => {
            activeMark = {start: m.index, template: template};
            draw();
            showPopupTable(m.index, template);
        };
        div.appendChild(d);
    });
    
    calculateFuture();
}

function showPopupTable(idx, template) {
    let h = "<table style='color:#000'>";
    for(let i=0; i<template.length; i++) {
        h += "<tr>";
        data[idx+i].forEach((v, j) => {
            let style = template[i][j] ? "match-circle" : "";
            h += `<td class="${style}">${v}</td>`;
        });
        h += "</tr>";
    }
    h += "</table>";
    document.getElementById("popData").innerHTML = h;
    document.getElementById("popup").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function calculateFuture() {
    let jodis = [], h = 5;
    topMatches.forEach(m => {
        let fRow = m.index + h;
        if(data[fRow] && data[fRow][targetCol] != "**") jodis.push(data[fRow][targetCol]);
    });
    
    if(jodis.length == 0) { document.getElementById("future").innerHTML = "Not enough data"; return; }
    
    let counts = {};
    jodis.forEach(j => counts[j] = (counts[j]||0)+1);
    let best = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
    
    document.getElementById("future").innerHTML = `Recommended Jodi: <b>${best}</b> (and its family)`;
}

function closePopup() { 
    document.getElementById("popup").style.display='none'; 
    document.getElementById("overlay").style.display='none'; 
}

draw();
</script>
</body>
</html>
