<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pattern Table System</title>

<style>
body{
  font-family: Arial;
  background:#f5f5f5;
}
h2{margin:8px 0}

.controls{margin-bottom:10px}

table{
  border-collapse:collapse;
  background:#fff;
  font-size:13px;
}
th,td{
  border:1px solid #999;
  padding:6px;
  text-align:center;
  min-width:42px;
  font-weight:600;
}
td[contenteditable]{
  background:#fffbe6;
}
.blank{
  background:#eee;
}
.circle{
  border:3px solid red !important;
  border-radius:50%;
}
.line-vert{
  box-shadow: inset 0 -4px red;
}
button{
  padding:6px 10px;
  margin-right:5px;
}
</style>
</head>

<body>

<h2>Pattern Table (CSV + LocalStorage)</h2>

<div class="controls">
  <input type="file" id="csvFile">
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="clearStorage()">Clear</button>
</div>

<div id="tableWrap"></div>

<script>
/* =====================
   HELPERS
===================== */
function norm(v){
  if(v==null) return "**";
  v=String(v).trim();
  if(v=="" || v=="**") return "**";
  return v.length==1 ? "0"+v : v;
}

/* =====================
   DATA
===================== */
let data = JSON.parse(localStorage.getItem("patternCSV")) || [];

/* =====================
   CSV LOAD
===================== */
document.getElementById("csvFile").addEventListener("change",e=>{
  let f=e.target.files[0];
  if(!f) return;
  let r=new FileReader();
  r.onload=()=>{
    let rows=r.result.trim().split(/\r?\n/);
    data=rows.map(r=>r.split(",").map(norm));
    save();
    draw();
  };
  r.readAsText(f);
});

/* =====================
   DRAW TABLE
===================== */
function draw(){
  let html="<table><tbody>";
  for(let i=0;i<data.length;i++){
    html+="<tr>";
    for(let j=0;j<data[i].length;j++){
      let v=data[i][j];
      let cls=v=="**"?"blank":"";
      html+=`<td class="${cls}" contenteditable
              data-r="${i}" data-c="${j}">${v}</td>`;
    }
    html+="</tr>";
  }
  html+="</tbody></table>";
  document.getElementById("tableWrap").innerHTML=html;
  bindEdit();
  applyPatterns();
}

/* =====================
   EDIT
===================== */
function bindEdit(){
  document.querySelectorAll("td[contenteditable]").forEach(td=>{
    td.onblur=()=>{
      let r=+td.dataset.r;
      let c=+td.dataset.c;
      data[r][c]=norm(td.innerText);
      save();
      draw();
    };
  });
}

/* =====================
   STORAGE
===================== */
function save(){
  localStorage.setItem("patternCSV",JSON.stringify(data));
}
function clearStorage(){
  if(confirm("Clear all data?")){
    localStorage.removeItem("patternCSV");
    data=[];
    draw();
  }
}

/* =====================
   CSV EXPORT
===================== */
function exportCSV(){
  let csv=data.map(r=>r.join(",")).join("\n");
  let b=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="pattern.csv";
  a.click();
}

/* =====================
   PATTERN ENGINE
   (Guaranteed visible)
===================== */
function applyPatterns(){
  document.querySelectorAll("td").forEach(td=>{
    td.classList.remove("circle","line-vert");
  });

  if(data.length < 4) return;

  let cols = data[0].length;

  for(let c=0;c<cols;c++){
    let a = data[data.length-2][c];
    let b = data[data.length-1][c];
    if(a=="**" || b=="**") continue;

    for(let r=0;r<data.length-2;r++){
      if(data[r][c]===a && data[r+1][c]===b){
        let td1=document.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
        let td2=document.querySelector(`td[data-r="${r+1}"][data-c="${c}"]`);
        if(td1) td1.classList.add("circle");
        if(td2) td2.classList.add("line-vert");
      }
    }
  }
}

/* =====================
   INIT DATA
===================== */
if(data.length==0){
  data=[
    ["01","12","23","34"],
    ["02","21","32","43"],
    ["01","12","23","34"],
    ["02","21","32","43"],
    ["01","12","23","34"],
    ["02","21","32","43"]
  ];
  save();
}
draw();
</script>

</body>
</html>
