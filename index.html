<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Matka Master Pro - Pattern Position Logic</title>
<style>
    :root { --gold: #ffd700; --red: #ff3131; --blue: #00a2ff; --bg: #0d0d0d; --panel: #1a1a1a; }
    body { font-family: 'Segoe UI', Arial; background: var(--bg); color: #fff; margin: 0; padding: 10px; }
    
    .toolbar { background: var(--panel); padding: 15px; border-radius: 8px; display: flex; gap: 10px; justify-content: center; border-bottom: 3px solid var(--gold); margin-bottom: 20px; }
    
    .chart-container { position: relative; display: inline-block; background: #fff; padding: 5px; border-radius: 4px; box-shadow: 0 0 30px rgba(255,215,0,0.2); }
    table { border-collapse: collapse; font-size: 13px; color: #000; position: relative; z-index: 2; }
    td, th { border: 1px solid #aaa; padding: 8px; text-align: center; font-weight: bold; width: 40px; height: 40px; }
    th { background: #500; color: white; }
    
    /* Marking */
    .circle { border: 3px solid var(--blue); border-radius: 50%; background: rgba(0, 162, 255, 0.15); }
    .base-point { background: var(--gold) !important; color: #000; border: 2px solid #000; border-radius: 4px; }
    .blank { background: #fffde7 !important; border: 2px dashed var(--red) !important; cursor: pointer; }

    .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
    .card { background: var(--panel); padding: 15px; border-radius: 10px; border-left: 4px solid var(--gold); }
    
    #matchList div { background: #252525; padding: 12px; margin: 8px 0; border-radius: 5px; cursor: pointer; border: 1px solid #333; }
    #matchList div:hover { background: #333; }

    /* Popup */
    #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border: 4px solid var(--gold); display: none; z-index: 1000; padding: 20px; border-radius: 10px; color: #000; width: 95%; max-width: 600px; box-shadow: 0 0 100px #000; max-height: 90vh; overflow: auto; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 999; }
    
    canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 5; }
    button { background: var(--gold); color: #000; border: none; padding: 10px 15px; font-weight: bold; border-radius: 4px; cursor: pointer; }
</style>
</head>
<body>

<div class="toolbar">
    <input type="file" id="csvFile" style="display:none">
    <button onclick="document.getElementById('csvFile').click()">üìÇ Upload CSV</button>
    <button onclick="addRow()">‚ûï Add Row</button>
    <button onclick="saveData()">üíæ Save Chart</button>
    <button onclick="localStorage.clear(); location.reload();" style="background:red; color:white;">üóëÔ∏è Reset</button>
</div>

<center>
    <div class="chart-container">
        <canvas id="mainCanvas"></canvas>
        <table id="mainTable"></table>
    </div>
</center>

<div class="container">
    <div class="card">
        <h3>üìç Strong Check Lines</h3>
        <div id="matchList">Click on (**) to scan 8-week pattern...</div>
    </div>
    <div class="card">
        <h3>ü§ñ Future AI Prediction</h3>
        <div id="prediction" style="font-size: 35px; color: var(--gold); text-align: center; font-weight: bold;">-- -- --</div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button onclick="closePopup()" style="float:right; background:red; color:white;">X</button>
    <h3 id="popTitle">Pattern Study View</h3>
    <div id="popContent" style="position:relative; display:inline-block; width: 100%;">
        <canvas id="popCanvas"></canvas>
        <div id="popTable"></div>
    </div>
</div>

<script>
const DB_KEY = "matka_v14_db";
const families = {"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"],"HR":["05","16","27","38","49","50","61","72","83","94"],"FR":["00","11","22","33","44","55","66","77","88","99"]};

function getFam(v){for(let k in families) if(families[k].includes(v)) return families[k]; return [v];}
function norm(v){v=String(v).trim(); return (v==""||v=="**") ? "**" : (v.length==1?"0"+v:v);}

let chart = JSON.parse(localStorage.getItem(DB_KEY)) || [["01","02","03","04","05","06"],["**","**","**","**","**","**"]];
let activeSet = null;

function renderChart() {
    let h = "<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>";
    chart.forEach((row, ri) => {
        h += "<tr>";
        row.forEach((cell, ci) => {
            let cls = (cell == "**") ? "blank" : "";
            if(activeSet && activeSet.points.some(p => p.r == ri && p.c == ci)) cls += " circle";
            if(activeSet && activeSet.baseR == ri && activeSet.baseC == ci) cls += " base-point";
            h += `<td class="${cls}" contenteditable="${cell!='**'}" oninput="edit(${ri},${ci},this)" onclick="${cell=='**'?`scanPattern(${ri},${ci})`:''}"> ${cell} </td>`;
        });
        h += "</tr>";
    });
    document.getElementById("mainTable").innerHTML = h;
    if(activeSet) setTimeout(() => drawLines("mainCanvas", "mainTable"), 50);
}

function scanPattern(r, c) {
    // 1. Find Base Point (Last jodi in current column)
    let baseJodi = ""; let bRow = -1;
    for(let i=r-1; i>=0; i--){ if(chart[i][c] !== "**"){ baseJodi=chart[i][c]; bRow=i; break; } }
    if(bRow == -1) return;

    // 2. Identify 8-week pattern set (Current Scenario)
    let scanDepth = 8;
    let startRow = Math.max(0, r - scanDepth);
    let patternPoints = [];
    
    for(let i = startRow; i < r; i++){
        for(let j=0; j<6; j++){
            if(chart[i][j] !== "**" && getFam(baseJodi).includes(chart[i][j])){
                patternPoints.push({ relR: i - bRow, relC: j - c }); // Store Relative Position
            }
        }
    }

    // 3. Search History for same Position + Family Matches
    let matches = [];
    for(let i=0; i < chart.length - scanDepth - 1; i++){
        let historyBase = chart[i][c]; // Same column/day
        if(historyBase === "**") continue;
        
        let score = 0;
        let points = [];
        patternPoints.forEach(p => {
            let targetR = i + p.relR;
            let targetC = c + p.relC;
            if(chart[targetR] && chart[targetR][targetC] !== "**"){
                if(getFam(historyBase).includes(chart[targetR][targetC])){
                    score++;
                    points.push({r: targetR, c: targetC});
                }
            }
        });

        if(score >= 2 && i < bRow - 5){
            matches.push({baseR: i, baseC: c, points: points, score: score});
        }
    }
    
    matches.sort((a,b) => b.score - a.score);
    displayMatches(matches, r, c);
}

function displayMatches(matches, originalR, originalC) {
    let list = document.getElementById("matchList");
    list.innerHTML = matches.length ? "" : "No Pattern Matched History.";
    let jodis = [];

    matches.slice(0, 4).forEach((m, idx) => {
        let div = document.createElement("div");
        div.innerHTML = `‚≠ê <b>Match Line #${idx+1}</b> (Score: ${m.score})<br><small>Historical Base Row: ${m.baseR + 1}</small>`;
        div.onclick = () => {
            activeSet = m;
            renderChart();
            showPopup(m);
        };
        list.appendChild(div);
        
        let pred = chart[m.baseR + (originalR - (originalR-1)) + 0] ? chart[m.baseR + (originalR - activeSet.baseR)][originalC] : "**"; 
        // Logic for future prediction based on historical next row
        let nextRow = m.baseR + (originalR - (originalR - (originalR - (originalR - (originalR-m.baseR)))) ); // Simple next
        if(chart[m.baseR+1]) jodis.push(chart[m.baseR+1][originalC]);
    });
    
    document.getElementById("prediction").innerText = [...new Set(jodis)].slice(0,3).join("  ");
}

function showPopup(match) {
    let h = "<table>";
    let start = Math.max(0, match.baseR - 8);
    for(let i = start; i <= match.baseR + 1; i++){
        h += "<tr>";
        if(!chart[i]) continue;
        chart[i].forEach((v, j) => {
            let isP = match.points.some(p => p.r == i && p.c == j);
            let isB = (match.baseR == i && match.baseC == j);
            let cls = isP ? "circle" : (isB ? "base-point" : "");
            h += `<td class="${cls}">${v}</td>`;
        });
        h += "</tr>";
    }
    document.getElementById("popTable").innerHTML = h + "</table>";
    document.getElementById("popup").style.display = "block";
    document.getElementById("overlay").style.display = "block";
    setTimeout(() => drawLines("popCanvas", "popTable"), 100);
}

function drawLines(cvsId, containerId) {
    const cvs = document.getElementById(cvsId);
    const tbl = document.getElementById(containerId).querySelector("table") || document.getElementById(containerId);
    const ctx = cvs.getContext("2d");
    cvs.width = tbl.offsetWidth; cvs.height = tbl.offsetHeight;
    ctx.clearRect(0,0,cvs.width,cvs.height);
    
    const points = tbl.querySelectorAll(".circle");
    const base = tbl.querySelector(".base-point");
    if(!base || points.length === 0) return;

    const tRect = tbl.getBoundingClientRect();
    const bRect = base.getBoundingClientRect();
    const x1 = bRect.left - tRect.left + bRect.width/2;
    const y1 = bRect.top - tRect.top + bRect.height/2;

    ctx.strokeStyle = "rgba(0, 162, 255, 0.7)"; ctx.lineWidth = 2;
    points.forEach(p => {
        const pRect = p.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(pRect.left - tRect.left + pRect.width/2, pRect.top - tRect.top + pRect.height/2);
        ctx.stroke();
    });
}

document.getElementById("csvFile").onchange = e => {
    let fr = new FileReader();
    fr.onload = () => {
        chart = fr.result.replace(/\./g, ",").split("\n").filter(l=>l.trim()).map(l => l.split(",").map(v => norm(v)));
        localStorage.setItem(DB_KEY, JSON.stringify(chart));
        renderChart();
    };
    fr.readAsText(e.target.files[0]);
};

function edit(r,c,el){ chart[r][c] = norm(el.innerText); }
function addRow(){ chart.push(["**","**","**","**","**","**"]); renderChart(); }
function saveData(){ localStorage.setItem(DB_KEY, JSON.stringify(chart)); alert("Saved!"); }
function closePopup(){ document.getElementById("popup").style.display="none"; document.getElementById("overlay").style.display="none"; }

renderChart();
</script>
</body>
</html>
