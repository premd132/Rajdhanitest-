<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Milan ‚Äì Pattern System Pro</title>
<style>
    body{font-family:'Segoe UI',Arial; background: #f4f4f4; margin: 20px;}
    .container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    table{border-collapse:collapse;font-size:14px; position: relative; z-index: 2; background: #fff;}
    td,th{border:1px solid #ccc;padding:8px;text-align:center;font-weight:600; width: 40px; height: 40px;}
    th { background: #333; color: #fff; }
    td[contenteditable]{background:#fffbe6}
    .blank{background:#eee !important;cursor:pointer; color: #999;}
    
    /* Marking Styles */
    .circle{border:3px solid red; border-radius:50%; background: rgba(255,0,0,0.1);}
    .base-yellow { background: #ffeb3b !important; border: 2px solid #fbc02d; border-radius: 4px; color: #000; }
    
    #checks div{background:#e3f2fd; margin:4px; padding:10px; cursor:pointer; border-radius: 4px; border-left: 5px solid #2196f3; font-weight: bold;}
    #ai,#future{background:#fff; border: 1px solid #ddd; padding:15px; margin-top:10px; border-radius: 8px;}
    
    #popup{position:fixed; left:50%; top:50%; transform: translate(-50%, -50%); background:#fff; border:2px solid #000; display:none; width: 90%; max-width: 500px; padding: 20px; z-index: 100; box-shadow: 0 0 20px rgba(0,0,0,0.5);}
    .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; z-index: 90;}
    
    canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 3; }
    button{padding: 8px 15px; cursor: pointer; background: #333; color: #fff; border: none; border-radius: 4px;}
</style>
</head>
<body>

<div class="container">
    <h2>üèÜ Milan Pattern System Pro</h2>
    <input type="file" id="csv">
    <button onclick="addRow()">Add Row</button>
    <button onclick="saveData()">Save Data</button>

    <div style="position: relative; display: inline-block; margin-top: 20px;">
        <canvas id="mainCanvas"></canvas>
        <table id="tbl"></table>
    </div>

    <div style="display: flex; gap: 20px; margin-top: 20px;">
        <div style="flex: 1;">
            <h3>üìç Check Lines (Family Match)</h3>
            <div id="checks"></div>
        </div>
        <div style="flex: 1;">
            <h3>ü§ñ AI & Future Prediction</h3>
            <div id="ai"></div>
            <div id="future"></div>
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button onclick="closePopup()" style="float:right">X</button>
    <h3>Connection View</h3>
    <div id="popData" style="position: relative; display: inline-block;">
        <canvas id="popCanvas"></canvas>
        <div id="popTableContent"></div>
    </div>
</div>

<script>
const STORAGE_KEY="pdata_Milan_Pro";
let targetCol=null;
let baseCell = {r: null, c: null};

/* FAMILY LOGIC */
const families={"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"],"HR":["05","16","27","38","49","50","61","72","83","94"],"FR":["00","11","22","33","44","55","66","77","88","99"]};

function fam(v){for(let k in families) if(families[k].includes(v)) return k; return "NA";}
function norm(v){if(v==""||v=="**")return "**";v=String(v);return v.length==1?"0"+v:v;}
function smartMatch(a,b){ if(a=="**"||b=="**") return false; return fam(a)===fam(b); }

let data=JSON.parse(localStorage.getItem(STORAGE_KEY)) || [["51","91","41","57","19","95"],["05","90","74","06","19","63"],["90","34","82","09","28","19"],["**","**","**","**","**","**"]];
data=data.map(r=>r.map(norm));

let activeMark=null;

function draw(){
    let h="<tr><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>";
    data.forEach((r,ri)=>{
        h+="<tr>";
        r.forEach((c,ci)=>{
            let cls="";
            if(activeMark && isPartOfPattern(ri, ci)) cls="circle";
            if(baseCell.r === ri && baseCell.c === ci) cls += " base-yellow";
            if(activeMark && activeMark.matchBaseR === ri && activeMark.matchBaseC === ci) cls += " base-yellow";

            if(c=="**") h+=`<td class="blank" onclick="makePattern(${ri},${ci})">**</td>`;
            else h+=`<td class="${cls}" contenteditable oninput="edit(${ri},${ci},this)">${c}</td>`;
        });
        h+="</tr>";
    });
    document.getElementById("tbl").innerHTML=h;
    if(activeMark) setTimeout(() => drawLines("mainCanvas", document.getElementById("tbl")), 50);
}

function isPartOfPattern(ri, ci){
    if(!activeMark) return false;
    let i=ri-activeMark.start;
    return (i>=0 && i<activeMark.shape.length && activeMark.shape[i][ci]);
}

function drawLines(cvsId, tblEl) {
    const cvs = document.getElementById(cvsId);
    const ctx = cvs.getContext("2d");
    cvs.width = tblEl.offsetWidth; cvs.height = tblEl.offsetHeight;
    ctx.clearRect(0,0,cvs.width,cvs.height);
    const cells = tblEl.querySelectorAll(".circle, .base-yellow");
    if(cells.length < 2) return;
    const tRect = tblEl.getBoundingClientRect();
    
    ctx.strokeStyle = "#2196f3"; ctx.lineWidth = 2;
    let base = tblEl.querySelector(".base-yellow").getBoundingClientRect();
    let x1 = base.left - tRect.left + base.width/2;
    let y1 = base.top - tRect.top + base.height/2;

    cells.forEach(c => {
        let r = c.getBoundingClientRect();
        ctx.beginPath(); ctx.moveTo(x1, y1);
        ctx.lineTo(r.left - tRect.left + r.width/2, r.top - tRect.top + r.height/2);
        ctx.stroke();
    });
}

function makePattern(r,c){
    targetCol=c; let base="**"; let bR = -1;
    for(let i=r-1;i>=0;i--){if(data[i][c]!="**"){base=data[i][c]; bR=i; break;}}
    if(base=="**") return;
    baseCell = {r: bR, c: c};

    let shape=[];
    for(let i=Math.max(0,r-4);i<=r;i++){
        let row=[];
        for(let j=0;j<6;j++){
            row.push(data[i][j]!="**" && smartMatch(data[i][j], base)?1:0);
        }
        shape.push(row);
    }
    searchPattern(shape, base, bR);
}

let lastMatches=[];
function searchPattern(shape, base, originalBaseR){
    lastMatches=[];
    for(let i=0;i<=data.length-shape.length;i++){
        let ok=true;
        for(let k=0;k<shape.length;k++){
            for(let j=0;j<6;j++){
                if(shape[k][j] && !smartMatch(data[i+k][j], base)){ok=false;break;}
            }
            if(!ok) break;
        }
        // ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§â‡§∏‡•Ä ‡§¶‡§ø‡§® (col) ‡§™‡§∞ ‡§´‡•à‡§Æ‡§ø‡§≤‡•Ä ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à
        let matchBaseInCol = (originalBaseR - (data.indexOf(data.find((row, idx) => idx >= (data.length - shape.length) )))); 
        if(ok) lastMatches.push({index:i, matchBaseR: i + (originalBaseR - (data.length - shape.length - 1 + shape.length - 5 )) });
    }
    showChecks(shape);
}

function showChecks(shape){
    const checks = document.getElementById("checks");
    checks.innerHTML="";
    lastMatches.slice(0,4).forEach((m,i)=>{
        let d=document.createElement("div");
        d.innerText=`Line Match #${i+1} (Row ${m.index + 1})`;
        d.onclick=()=>{
            activeMark={start:m.index, shape:shape, matchBaseR: m.index + (baseCell.r - (data.length - 5)), matchBaseC: targetCol};
            draw();
            showPopup(m.index, shape);
        };
        checks.appendChild(d);
    });
    showAISuggestions(shape);
}

function showPopup(idx, shape){
    let html="<table>";
    for(let i=0;i<shape.length;i++){
        html+="<tr>";
        data[idx+i].forEach((v,j)=>{
            let isB = (idx+i === activeMark.matchBaseR && j === targetCol);
            let cls = shape[i][j] ? "circle" : "";
            if(isB) cls += " base-yellow";
            html+=`<td class="${cls}">${v}</td>`;
        });
        html+="</tr>";
    }
    document.getElementById("popTableContent").innerHTML=html + "</table>";
    document.getElementById("popup").style.display="block";
    document.getElementById("overlay").style.display="block";
    setTimeout(() => drawLines("popCanvas", document.getElementById("popTableContent").querySelector("table")), 100);
}

function closePopup(){
    document.getElementById("popup").style.display="none";
    document.getElementById("overlay").style.display="none";
}

function showAISuggestions(shape){
    // ... (Your original AI logic here)
    document.getElementById("ai").innerHTML = "AI Suggestion Updated based on Family Matches.";
}

function edit(r,c,el){data[r][c]=norm(el.innerText.trim());}
function addRow(){data.push(["**","**","**","**","**","**"]);draw();}
function saveData(){localStorage.setItem(STORAGE_KEY,JSON.stringify(data));alert("Saved!");}

draw();
</script>
</body>
</html>
