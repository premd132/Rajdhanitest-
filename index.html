<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pattern Table – Final</title>

<style>
body{
  font-family: Arial;
  background:#f5f5f5;
}
h2{margin:6px 0}
.controls{margin-bottom:10px}

table{
  border-collapse:collapse;
  background:#fff;
  font-size:13px;
}
td{
  border:1px solid #999;
  padding:6px;
  text-align:center;
  min-width:42px;
  font-weight:600;
  cursor:pointer;
}
td[contenteditable]{
  background:#fffbe6;
}
.blank{background:#eee}

.circle{
  border:3px solid red !important;
  border-radius:50%;
}
.line{
  box-shadow: inset 0 -4px red;
}

button{
  padding:6px 10px;
  margin-right:5px;
}
</style>
</head>

<body>

<h2>Pattern Table (Manual + Auto)</h2>

<div class="controls">
  <input type="file" id="csvFile">
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="clearAll()">Clear</button>
</div>

<div id="tableWrap"></div>

<script>
/* ========= HELPERS ========= */
function norm(v){
  if(v==null) return "**";
  v=String(v).trim();
  if(v=="" || v=="**") return "**";
  return v.length==1 ? "0"+v : v;
}

/* ========= DATA ========= */
let data = JSON.parse(localStorage.getItem("csvData")) || [];
let marks = JSON.parse(localStorage.getItem("marks")) || {}; 
// marks: {"r-c":"circle|line"}

/* ========= CSV LOAD ========= */
csvFile.onchange = e=>{
  let f=e.target.files[0];
  if(!f) return;
  let r=new FileReader();
  r.onload=()=>{
    data = r.result.trim().split(/\r?\n/)
      .map(r=>r.split(",").map(norm));
    marks={};
    save();
    draw();
  };
  r.readAsText(f);
};

/* ========= DRAW ========= */
function draw(){
  let html="<table><tbody>";
  for(let r=0;r<data.length;r++){
    html+="<tr>";
    for(let c=0;c<data[r].length;c++){
      let v=data[r][c];
      let k=r+"-"+c;
      let cls=(v=="**"?"blank ":"")+(marks[k]||"");
      html+=`<td class="${cls}" 
        data-r="${r}" data-c="${c}" contenteditable>${v}</td>`;
    }
    html+="</tr>";
  }
  html+="</tbody></table>";
  tableWrap.innerHTML=html;
  bind();
}

/* ========= EVENTS ========= */
function bind(){
  document.querySelectorAll("td").forEach(td=>{
    // edit
    td.onblur=()=>{
      let r=+td.dataset.r,c=+td.dataset.c;
      data[r][c]=norm(td.innerText);
      save(); draw();
    };

    // manual marking (VIDEO STYLE)
    td.onclick=e=>{
      if(e.shiftKey){
        let k=td.dataset.r+"-"+td.dataset.c;
        if(marks[k]=="circle") marks[k]="line";
        else if(marks[k]=="line") delete marks[k];
        else marks[k]="circle";
        save(); draw();
      }
    };
  });
}

/* ========= STORAGE ========= */
function save(){
  localStorage.setItem("csvData",JSON.stringify(data));
  localStorage.setItem("marks",JSON.stringify(marks));
}
function clearAll(){
  if(confirm("Clear all?")){
    localStorage.clear();
    data=[]; marks={};
    draw();
  }
}

/* ========= CSV EXPORT ========= */
function exportCSV(){
  let csv=data.map(r=>r.join(",")).join("\n");
  let b=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="pattern.csv";
  a.click();
}

/* ========= AUTO BASIC PATTERN ========= */
function autoPattern(){
  if(data.length<4) return;
  let cols=data[0].length;

  for(let c=0;c<cols;c++){
    let a=data[data.length-2][c];
    let b=data[data.length-1][c];
    for(let r=0;r<data.length-2;r++){
      if(data[r][c]==a && data[r+1][c]==b){
        marks[r+"-"+c]="circle";
        marks[(r+1)+"-"+c]="line";
      }
    }
  }
  save();
}

/* ========= INIT ========= */
if(data.length==0){
  data=[
    ["01","12","23","34"],
    ["02","21","32","43"],
    ["01","12","23","34"],
    ["02","21","32","43"]
  ];
  autoPattern();
}
draw();
</script>

<p>
<b>USE:</b><br>
• Cell edit → normal click<br>
• <b>SHIFT + click</b> → Circle → Line → Remove (video jaisa)<br>
• Reload → sab save rahega
</p>

</body>
</html>
