<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matka Advanced Logic Tool</title>
    <style>
        :root { --gold: #ffd700; --bg: #1a1a1a; --panel: #2d2d2d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; overflow-x: hidden; }
        
        /* Header Controls */
        .header { background: var(--panel); padding: 15px; border-radius: 10px; border: 1px solid #444; margin-bottom: 10px; }
        .grid-ctrl { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; }
        
        input, select { background: #000; color: var(--gold); border: 1px solid var(--gold); padding: 8px; border-radius: 5px; font-weight: bold; width: 100%; box-sizing: border-box; }
        label { font-size: 12px; color: #bbb; display: block; margin-bottom: 4px; }

        /* Table & Canvas Area */
        .table-wrapper { position: relative; background: #fff; border-radius: 5px; margin-top: 10px; overflow: auto; }
        table { width: 100%; border-collapse: collapse; color: #000; font-weight: bold; table-layout: fixed; }
        th, td { border: 1px solid #999; padding: 12px 5px; text-align: center; position: relative; }
        th { background: #800000; color: white; font-size: 13px; }

        /* Marking Elements */
        .jodi-cell { display: inline-block; width: 40px; height: 40px; line-height: 40px; font-size: 18px; position: relative; z-index: 5; cursor: pointer; outline: none; }
        .base-mark { border: 3px solid red; background: rgba(255,0,0,0.1); border-radius: 4px; } /* üî≥ Chokor */
        .family-mark { border: 3px solid blue; border-radius: 50%; background: rgba(0,0,255,0.1); } /* ‚≠ï Round */

        #lineCanvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 10; }

        /* Buttons */
        .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .btn-search { background: var(--gold); color: black; width: 100%; }
        .btn-tool { background: #444; color: white; font-size: 11px; }
    </style>
</head>
<body>

<div class="header">
    <div class="grid-ctrl">
        <div><label>Market</label><select id="market"><option>KALYAN</option><option>RAJDHANI</option></select></div>
        <div><label>Search Day</label><select id="daySelect"><option value="0">MON</option><option value="1">TUE</option><option value="2">WED</option><option value="3">THU</option><option value="4">FRI</option><option value="5">SAT</option></select></div>
        <div><label>Base Jodi</label><input type="text" id="baseJodi" placeholder="00" maxlength="2"></div>
        <div><label>Rows (Up)</label><input type="number" id="rowRange" value="8"></div>
        <div><label>&nbsp;</label><button class="btn btn-search" onclick="runLogic()">Run Pattern</button></div>
    </div>
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="handleCSV(this.files)">
        <button class="btn btn-tool" onclick="document.getElementById('csvFile').click()">üìÇ Upload CSV</button>
        <button class="btn btn-tool" onclick="addNewRow()">‚ûï Add Row</button>
        <button class="btn btn-tool" onclick="clearAll()" style="background:#800000;">üóëÔ∏è Clear Data</button>
    </div>
</div>

<div class="table-wrapper" id="tableWrapper">
    <canvas id="lineCanvas"></canvas>
    <table id="mainTable">
        <thead>
            <tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const tableBody = document.getElementById('tableBody');
    const canvas = document.getElementById('lineCanvas');
    const ctx = canvas.getContext('2d');

    // 1. Auto Padding & Family Logic
    function formatJ(v) { 
        v = v.toString().replace(/[^0-9]/g, '');
        return v.length === 1 ? "0"+v : (v.length === 0 ? "00" : v.slice(0,2));
    }

    function getFamily(j) {
        let a = parseInt(j[0]), b = parseInt(j[1]);
        let c = (n) => (n + 5) % 10;
        return [...new Set([`${a}${b}`,`${c(a)}${b}`,`${a}${c(b)}`,`${c(a)}${c(b)}`,`${b}${a}`,`${c(b)}${a}`,`${b}${c(a)}`,`${c(b)}${c(a)}` ])];
    }

    // 2. Add Row & LocalStorage
    function addNewRow(data = ["00","00","00","00","00","00"], isInitial = false) {
        const tr = document.createElement('tr');
        data.forEach(val => {
            const td = document.createElement('td');
            td.innerHTML = `<span class="jodi-cell" contenteditable="true" onblur="saveData()">${formatJ(val)}</span>`;
            tr.appendChild(td);
        });
        tableBody.appendChild(tr);
        if(!isInitial) saveData();
    }

    // 3. CSV Upload (Fixed)
    function handleCSV(files) {
        const reader = new FileReader();
        reader.onload = (e) => {
            tableBody.innerHTML = "";
            e.target.result.split('\n').forEach(line => {
                if(line.trim()) {
                    let cols = line.split(',');
                    // Agar CSV me date hai to use hata ke 6 jodi lega
                    addNewRow(cols.length > 6 ? cols.slice(1,7) : cols, true);
                }
            });
            saveData();
            window.location.reload();
        };
        reader.readAsText(files[0]);
    }

    // 4. Main Pattern Logic & Line Drawing
    function runLogic() {
        // Reset
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.querySelectorAll('.jodi-cell').forEach(c => c.className = 'jodi-cell');
        
        const dayIdx = parseInt(document.getElementById('daySelect').value);
        const base = formatJ(document.getElementById('baseJodi').value);
        const range = parseInt(document.getElementById('rowRange').value);
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        
        canvas.width = document.getElementById('mainTable').offsetWidth;
        canvas.height = document.getElementById('mainTable').offsetHeight;

        const family = getFamily(base);
        
        // Search Bottom to Top
        for (let i = rows.length - 1; i >= 0; i--) {
            let baseCell = rows[i].children[dayIdx].querySelector('.jodi-cell');
            if(baseCell.innerText === base) {
                baseCell.classList.add('base-mark');
                
                let bRect = baseCell.getBoundingClientRect();
                let bX = (bRect.left + bRect.width/2) - canvas.getBoundingClientRect().left;
                let bY = (bRect.top + bRect.height/2) - canvas.getBoundingClientRect().top;

                // Search Rows Above
                for (let r = 1; r <= range; r++) {
                    if(i - r >= 0) {
                        rows[i-r].querySelectorAll('.jodi-cell').forEach(fCell => {
                            if(family.includes(fCell.innerText)) {
                                fCell.classList.add('family-mark');
                                
                                // Draw Line
                                let fRect = fCell.getBoundingClientRect();
                                let fX = (fRect.left + fRect.width/2) - canvas.getBoundingClientRect().left;
                                let fY = (fRect.top + fRect.height/2) - canvas.getBoundingClientRect().top;
                                
                                ctx.beginPath();
                                ctx.moveTo(bX, bY);
                                ctx.lineTo(fX, fY);
                                ctx.strokeStyle = "red";
                                ctx.lineWidth = 2;
                                ctx.stroke();
                            }
                        });
                    }
                }
            }
        }
    }

    // 5. Storage Functions
    function saveData() {
        let arr = [];
        tableBody.querySelectorAll('tr').forEach(tr => {
            let row = [];
            tr.querySelectorAll('.jodi-cell').forEach(s => row.push(s.innerText));
            arr.push(row);
        });
        localStorage.setItem('matka_jodi_db', JSON.stringify(arr));
    }

    function loadData() {
        let saved = localStorage.getItem('matka_jodi_db');
        if(saved) JSON.parse(saved).forEach(r => addNewRow(r, true));
        else for(let i=0; i<15; i++) addNewRow(undefined, true);
    }

    function clearAll() { if(confirm("Delete all?")) { localStorage.clear(); location.reload(); } }

    window.onload = loadData;
</script>
</body>
</html>
