<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pro Line Analyzer ‚Äì Master Trick System</title>
<style>
    :root { --gold: #ffd700; --blue: #007bff; --bg: #0f0f0f; --panel: #1a1a1a; }
    body { font-family: 'Segoe UI', Arial; background: var(--bg); color: #fff; margin: 0; padding: 10px; }
    
    /* Toolbar & Layout */
    .toolbar { background: var(--panel); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; border-bottom: 3px solid var(--gold); }
    
    /* Chart Styles */
    .chart-wrapper { position: relative; display: inline-block; background: #fff; padding: 5px; border-radius: 4px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    table { border-collapse: collapse; font-size: 13px; color: #000; position: relative; z-index: 2; }
    td, th { border: 1px solid #aaa; padding: 6px; text-align: center; font-weight: bold; width: 40px; height: 40px; cursor: cell; }
    th { background: #500; color: white; font-size: 11px; }
    
    /* Marking Styles from Photos */
    .circle { border: 3px solid var(--blue); border-radius: 50%; background: rgba(0, 123, 255, 0.1); }
    .blank-target { background: #fff9c4 !important; border: 2px dashed #d32f2f !important; }
    .base-hit { background: var(--gold) !important; color: #000; border-radius: 4px; border: 2px solid #000; }
    
    /* Analysis Cards */
    .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
    .card { background: var(--panel); padding: 15px; border-radius: 10px; border-left: 5px solid var(--gold); }
    .match-item { background: #252525; padding: 12px; margin: 8px 0; border-radius: 6px; cursor: pointer; border: 1px solid #333; transition: 0.3s; }
    .match-item:hover { background: #333; transform: scale(1.02); }

    /* Line Study Popup */
    #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border: 5px solid var(--gold); display: none; z-index: 1000; padding: 20px; border-radius: 15px; color: #000; width: 95%; max-width: 600px; box-shadow: 0 0 100px #000; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 999; }
    
    canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 5; }
    .prediction-box { font-size: 36px; color: var(--gold); text-align: center; font-weight: bold; text-shadow: 0 0 10px var(--gold); }
    button { background: var(--gold); color: #000; border: none; padding: 10px 20px; font-weight: bold; border-radius: 5px; cursor: pointer; }
</style>
</head>
<body>

<div class="toolbar">
    <input type="file" id="csv" style="display:none">
    <button onclick="document.getElementById('csv').click()">üìÇ Upload Record</button>
    <button onclick="addRow()">‚ûï Add Week</button>
    <button onclick="saveChart()" style="background:#28a745; color:#fff;">üíæ Save Chart</button>
</div>

<center>
    <div class="chart-wrapper">
        <canvas id="mainCanvas"></canvas>
        <table id="mainTable"></table>
    </div>
</center>

<div class="container">
    <div class="card">
        <h3>üìç Strong Check Lines (History)</h3>
        <div id="checkList">Click on any (**) to scan 8-week line study...</div>
    </div>
    <div class="card">
        <h3>ü§ñ Line Study Logic</h3>
        <div id="logicReport" style="font-size: 14px; color: #bbb;">Select a pattern to see movement analysis.</div>
    </div>
    <div class="card">
        <h3>üîÆ Master AI (Top 3 Jodi)</h3>
        <div id="aiPrediction" class="prediction-box">-- -- --</div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button onclick="closePopup()" style="float:right; background:red; color:white;">X</button>
    <h3 style="margin-top:0;">üîé Line Trick Study View</h3>
    <div id="popContent" style="position:relative; display:inline-block; width: 100%;">
        <canvas id="popCanvas"></canvas>
        <div id="popTable"></div>
    </div>
</div>

<script>
const DB_NAME = "pro_analyzer_v1";
const families={"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"],"HR":["05","16","27","38","49","50","61","72","83","94"],"FR":["00","11","22","33","44","55","66","77","88","99"]};

function getFam(v){for(let k in families) if(families[k].includes(v)) return families[k]; return [v];}
function norm(v){v=String(v).trim(); return (v==""||v=="**") ? "**" : (v.length==1?"0"+v:v);}

let chartData = JSON.parse(localStorage.getItem(DB_NAME)) || [["02","84","00","67","06","98"],["**","**","**","**","**","**"]];
let activeLine = null;

function renderChart() {
    let h = "<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>";
    chartData.forEach((row, ri) => {
        h += "<tr>";
        row.forEach((cell, ci) => {
            let cls = (cell == "**") ? "blank-target" : "";
            if(activeLine && activeLine.points.some(p => p.r == ri && p.c == ci)) cls += " circle";
            if(activeLine && activeLine.baseR == ri && activeLine.baseC == ci) cls += " base-hit";
            h += `<td class="${cls}" contenteditable="${cell!='**'}" oninput="edit(${ri},${ci},this)" onclick="${cell=='**'?`startLineStudy(${ri},${ci})`:''}"> ${cell} </td>`;
        });
        h += "</tr>";
    });
    document.getElementById("mainTable").innerHTML = h;
    if(activeLine) setTimeout(() => drawVisualLines("mainCanvas", "mainTable"), 50);
}

function startLineStudy(r, c) {
    let studyBlock = 8; // Photo ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ 8 ‡§π‡§´‡§º‡•ç‡§§‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•ç‡§ü‡§°‡•Ä
    let startRow = Math.max(0, r - studyBlock);
    let pattern = [];
    
    for(let i = startRow; i < r; i++){
        pattern.push(chartData[i].map(v => v !== "**" ? v : null));
    }
    
    // ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§Æ‡•á‡§Ç ‡§á‡§∏‡•Ä ‡§§‡§∞‡§π ‡§ï‡•Ä ‡§ö‡§æ‡§≤ ‡§ñ‡•ã‡§ú‡§®‡§æ (Matching Line Patterns)
    let matches = [];
    for(let i = 0; i < chartData.length - studyBlock - 1; i++){
        let matchScore = 0;
        let points = [];
        for(let k = 0; k < studyBlock; k++){
            for(let j = 0; j < 6; j++){
                if(pattern[k][j] && getFam(pattern[k][j]).includes(chartData[i+k][j])){
                    matchScore++;
                    points.push({r: i+k, c: j});
                }
            }
        }
        if(matchScore >= 4) matches.push({index: i, score: matchScore, points: points});
    }
    
    matches.sort((a,b) => b.score - a.score);
    displayMatches(matches, studyBlock, c);
}

function displayMatches(matches, blockLen, col) {
    let list = document.getElementById("checkList");
    list.innerHTML = "";
    let jodiPool = [];

    matches.slice(0, 3).forEach((m, idx) => {
        let div = document.createElement("div");
        div.className = "match-item";
        div.innerHTML = `<b>Study Line #${idx+1}</b> (Score: ${m.score})<br><small>Movement found at Row ${m.index+1}</small>`;
        div.onclick = () => {
            activeLine = {points: m.points, baseR: m.index + blockLen, baseC: col};
            renderChart();
            openLinePopup(m.index, blockLen, col, m.points);
        };
        list.appendChild(div);
        
        let pred = chartData[m.index + blockLen][col];
        if(pred !== "**") jodiPool.push(pred);
    });

    document.getElementById("aiPrediction").innerText = jodiPool.length ? jodiPool.join("  ") : "-- -- --";
    document.getElementById("logicReport").innerHTML = `Analyzed 8-week cross movements. Found ${matches.length} matches. Top 3 lines isolated for study.`;
}

function openLinePopup(idx, block, col, pts) {
    let h = "<table>";
    for(let i=0; i <= block; i++){
        h += "<tr>";
        chartData[idx+i].forEach((v, j) => {
            let isPt = pts.some(p => p.r == idx+i && p.c == j);
            let isHit = (i == block && j == col);
            let cls = isPt ? "circle" : (isHit ? "base-hit" : "");
            h += `<td class="${cls}">${v}</td>`;
        });
        h += "</tr>";
    }
    document.getElementById("popTable").innerHTML = h + "</table>";
    document.getElementById("popup").style.display = "block";
    document.getElementById("overlay").style.display = "block";
    setTimeout(() => drawVisualLines("popCanvas", "popTable"), 100);
}

function drawVisualLines(cvsId, containerId) {
    const cvs = document.getElementById(cvsId);
    const tbl = document.getElementById(containerId).querySelector("table") || document.getElementById(containerId);
    const ctx = cvs.getContext("2d");
    cvs.width = tbl.offsetWidth; cvs.height = tbl.offsetHeight;
    ctx.clearRect(0,0,cvs.width,cvs.height);
    
    const points = tbl.querySelectorAll(".circle");
    const hit = tbl.querySelector(".base-hit");
    if(!hit || points.length === 0) return;

    const tRect = tbl.getBoundingClientRect();
    const hRect = hit.getBoundingClientRect();
    const x2 = hRect.left - tRect.left + hRect.width/2;
    const y2 = hRect.top - tRect.top + hRect.height/2;

    ctx.strokeStyle = "rgba(0, 123, 255, 0.7)";
    ctx.lineWidth = 2;
    points.forEach(p => {
        const pRect = p.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(pRect.left - tRect.left + pRect.width/2, pRect.top - tRect.top + pRect.height/2);
        ctx.lineTo(x2, y2);
        ctx.stroke();
    });
}

// CSV/System Functions
document.getElementById("csv").onchange = e => {
    let fr = new FileReader();
    fr.onload = () => {
        chartData = fr.result.replace(/\./g, ",").split("\n").filter(l=>l.trim()).map(l => l.split(",").map(v => norm(v)));
        renderChart();
    };
    fr.readAsText(e.target.files[0]);
};

function edit(r,c,el){ chartData[r][c] = norm(el.innerText); }
function addRow(){ chartData.push(["**","**","**","**","**","**"]); renderChart(); }
function saveChart(){ localStorage.setItem(DB_NAME, JSON.stringify(chartData)); alert("Study Data Saved!"); }
function closePopup(){ document.getElementById("popup").style.display="none"; document.getElementById("overlay").style.display="none"; }

renderChart();
</script>
</body>
</html>
