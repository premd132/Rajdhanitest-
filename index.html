<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jodi Pattern â€“ Same Column (Final)</title>
<style>
body{font-family:Arial;background:#f6f1d3;margin:10px}
.controls{margin-bottom:8px}
table{border-collapse:collapse}
td,th{
  border:1px solid #999;
  width:56px;height:32px;
  text-align:center;
  font-weight:700;position:relative;
  background:#fbf6db;
}
th{background:#eee}
.square{outline:3px solid #000}
.circle{border:3px solid #1f66ff;border-radius:50%}
svg{position:absolute;top:0;left:0;pointer-events:none}
.btn{margin-left:6px}
.small{font-size:12px}
</style>
</head>
<body>

<div class="controls">
Market:
<select id="market">
  <option>Kalyan</option><option>Rajdhani</option><option>Milan</option>
</select>

Day:
<select id="day">
  <option value="0">Mon</option><option value="1">Tue</option><option value="2">Wed</option>
  <option value="3">Thu</option><option value="4">Fri</option><option value="5">Sat</option>
</select>

Base Jodi:
<input id="base" size="3" value="20">

Rows:
<select id="rows"></select>

<button class="btn" onclick="search()">SEARCH</button>
<button class="btn" onclick="clearMarks()">Clear</button>
</div>

<div class="controls small">
CSV:
<input type="file" id="csv">
<button class="btn" onclick="upload()">Upload</button>
<button class="btn" onclick="addRow()">Add Row</button>
</div>

<div id="wrap" style="position:relative;margin-top:6px">
<svg id="lines"></svg>
<table id="tbl">
  <thead>
    <tr>
      <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<script>
// ================= FAMILY (SAME AS YOU) =================
const FAMILIES={
"12":["12","17","21","26","62","67","71","76"],
"13":["13","18","31","36","63","68","81","86"],
"14":["14","19","41","46","64","69","91","96"],
"15":["01","06","10","15","51","56","60","65"],
"23":["23","28","32","37","73","78","82","87"],
"24":["24","29","42","47","74","79","92","97"],
"25":["02","07","20","25","52","57","70","75"],
"34":["34","39","43","48","84","89","93","98"],
"35":["03","08","30","35","53","58","80","85"],
"45":["04","09","40","45","54","59","90","95"],
"half":["05","16","27","38","49","50","61","72","83","94"],
"full":["00","11","22","33","44","55","66","77","88","99"]
};

// ================= UTIL =================
const pad=v=>{
 if(v==="**") return "**";
 v=String(v).replace(/[^0-9]/g,"");
 if(v==="") return "**";
 return v.length===1 ? "0"+v : v.slice(-2);
};
const palti=v=>v[1]+v[0];
const familyOf=v=>{
 for(const k in FAMILIES) if(FAMILIES[k].includes(v)) return k;
 return null;
};
const match=(base,v)=>{
 if(v==="**") return false;
 if(v===base) return true;
 if(palti(v)===base) return true;
 const f=familyOf(base);
 return f && FAMILIES[f].includes(v);
};

// ================= DATA =================
let data=[]; // rows x 6
const tbody=document.querySelector("#tbl tbody");

// rows selector 1..10
for(let i=1;i<=10;i++){
 const o=document.createElement("option");
 o.value=i;o.text=i;rows.appendChild(o);
}

// ================= STORAGE =================
function save(){localStorage.setItem("jodiData",JSON.stringify(data));}
function load(){
 const d=localStorage.getItem("jodiData");
 if(d){data=JSON.parse(d); render();}
}
load();

// ================= CSV =================
function upload(){
 const f=csv.files[0]; if(!f) return;
 const r=new FileReader();
 r.onload=()=>{
  const lines=r.result.trim().split(/\n+/);
  data=lines.map(line=>{
    const p=line.split(".");
    const row=[];
    for(let i=0;i<6;i++) row[i]=pad(p[i]??"**");
    return row;
  });
  save(); render();
 };
 r.readAsText(f);
}

// ================= TABLE =================
function render(){
 tbody.innerHTML="";
 data.forEach((row,ri)=>{
  const tr=document.createElement("tr");
  row.forEach((v,ci)=>{
    const td=document.createElement("td");
    td.textContent=v;
    td.dataset.r=ri; td.dataset.c=ci;
    td.contentEditable=true;
    td.oninput=()=>{
      data[ri][ci]=pad(td.textContent);
      save(); render();
    };
    tr.appendChild(td);
  });
  tbody.appendChild(tr);
 });
 resizeSVG();
}
function addRow(){
 if(!data.length) data.push(["**","**","**","**","**","**"]);
 else data.push(["**","**","**","**","**","**"]);
 save(); render();
}

// ================= SEARCH (SAME COLUMN ONLY) =================
function search(){
 clearMarks();
 const base=pad(document.getElementById("base").value);
 const col=parseInt(day.value,10);
 const R=parseInt(rows.value,10);

 // scan from bottom to top
 for(let r=data.length-1; r>=0; r--){
   if(data[r][col]===base){
     // base found -> square
     markSquare(r,col);

     // look UP only within selected rows
     const hits=[];
     for(let k=1;k<=R;k++){
       const rr=r-k;
       if(rr<0) break;
       const v=data[rr][col];
       if(match(base,v)) hits.push({r:rr,c:col});
     }

     // mark circles + check line
     hits.forEach(h=>markCircle(h.r,h.c));
     if(hits.length>1) drawVerticalLine(r,col,hits);
   }
 }
}

// ================= MARKING =================
function cell(r,c){
 return document.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
}
function markSquare(r,c){ cell(r,c).classList.add("square"); }
function markCircle(r,c){ cell(r,c).classList.add("circle"); }

function drawVerticalLine(baseR,c,hits){
 // connect in order top->down to look photo-like
 const pts=hits.slice().sort((a,b)=>a.r-b.r);
 for(let i=0;i<pts.length-1;i++){
   const A=cell(pts[i].r,c).getBoundingClientRect();
   const B=cell(pts[i+1].r,c).getBoundingClientRect();
   const box=lines.getBoundingClientRect();
   const L=document.createElementNS("http://www.w3.org/2000/svg","line");
   L.setAttribute("x1",A.left+A.width/2-box.left);
   L.setAttribute("y1",A.top+A.height/2-box.top);
   L.setAttribute("x2",B.left+B.width/2-box.left);
   L.setAttribute("y2",B.top+B.height/2-box.top);
   L.setAttribute("stroke","#1f66ff");
   L.setAttribute("stroke-width","2");
   lines.appendChild(L);
 }
}

// ================= CLEAR =================
function clearMarks(){
 document.querySelectorAll(".square,.circle").forEach(e=>{
  e.classList.remove("square","circle");
 });
 lines.innerHTML="";
}
function resizeSVG(){
 const t=document.getElementById("tbl").getBoundingClientRect();
 lines.setAttribute("width",t.width);
 lines.setAttribute("height",t.height);
}
</script>
</body>
</html>
