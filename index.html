<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Pattern AI - No.1 Table Trick</title>
    <style>
        :root { --gold: #ffcc00; --red: #ff3131; --blue: #007bff; --bg: #121212; --panel: #1e1e1e; }
        body { font-family: 'Segoe UI', Arial; background: var(--bg); color: #fff; margin: 0; padding: 10px; }
        
        .header { text-align: center; border-bottom: 2px solid var(--gold); margin-bottom: 15px; padding-bottom: 10px; }
        .header h1 { color: var(--gold); margin: 0; font-size: 24px; text-transform: uppercase; }

        .toolbar { background: var(--panel); padding: 15px; border-radius: 8px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; border: 1px solid #444; }
        
        /* Table Design */
        .table-container { position: relative; display: inline-block; background: #fff; border-radius: 4px; padding: 5px; box-shadow: 0 0 20px rgba(0,0,0,0.5); margin-top: 15px; }
        table { border-collapse: collapse; font-size: 14px; color: #000; z-index: 2; position: relative; }
        td, th { border: 1px solid #bbb; padding: 10px 5px; text-align: center; font-weight: bold; width: 42px; height: 42px; }
        th { background: #800000; color: white; font-size: 12px; }
        
        .blank { background: #fffde6 !important; cursor: pointer; border: 2px dashed var(--red) !important; color: #999; }
        .circle { border: 3px solid var(--red) !important; border-radius: 50%; background: rgba(255, 49, 49, 0.1); }
        .base-mark { background: var(--gold) !important; border: 2px solid #000; border-radius: 4px; color: #000; }
        
        /* Analysis Cards */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .card { background: var(--panel); padding: 15px; border-radius: 10px; border-top: 4px solid var(--gold); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card h3 { color: var(--gold); margin: 0 0 10px 0; border-bottom: 1px solid #444; padding-bottom: 5px; }
        
        #checks div { background: #2a2a2a; padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; border-left: 4px solid var(--blue); transition: 0.3s; }
        #checks div:hover { background: #333; }
        
        .future-val { font-size: 45px; color: var(--gold); text-align: center; font-weight: bold; text-shadow: 0 0 10px rgba(255,204,0,0.5); }

        canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 5; }
        button { background: var(--gold); color: #000; border: none; padding: 10px 18px; font-weight: bold; border-radius: 5px; cursor: pointer; text-transform: uppercase; }
        button:hover { filter: brightness(1.2); }
    </style>
</head>
<body>

<div class="header">
    <h1>üèÜ MASTER PATTERN SYSTEM PRO</h1>
</div>

<div class="toolbar">
    <input type="file" id="csvFile" style="display:none">
    <button onclick="document.getElementById('csvFile').click()">üìÇ Upload CSV</button>
    <button onclick="addRow()">‚ûï Add Row</button>
    <button onclick="saveData()" style="background:#28a745; color:white;">üíæ Save Chart</button>
    <button onclick="clearData()" style="background:#dc3545; color:white;">üóëÔ∏è Reset</button>
</div>

<center>
    <div class="table-container">
        <canvas id="mainCanvas"></canvas>
        <table id="mainTable"></table>
    </div>
</center>

<div class="dashboard">
    <div class="card">
        <h3>üìç Table Trick Connections</h3>
        <div id="checks">Select blank (**) to scan history...</div>
    </div>
    
    <div class="card">
        <h3>ü§ñ Master AI Report</h3>
        <div id="aiReport" style="line-height: 1.6;">Awaiting Pattern Selection...</div>
    </div>
    
    <div class="card">
        <h3>üîÆ Super Future AI</h3>
        <div id="futureJodi" class="future-val">--</div>
    </div>
</div>

<script>
const DB_KEY = "master_pro_v90";
const families={"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"],"HR":["05","16","27","38","49","50","61","72","83","94"],"FR":["00","11","22","33","44","55","66","77","88","99"]};

function getFamily(v){for(let k in families) if(families[k].includes(v)) return families[k]; return [v];}
function norm(v){v=String(v).trim(); if(v==""||v=="**") return "**"; return v.length==1?"0"+v:v;}

let chartData = JSON.parse(localStorage.getItem(DB_KEY)) || [["12","34","56","78","90","11"],["**","**","**","**","**","**"]];
let activePattern = null;

function render() {
    let html = "<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>";
    chartData.forEach((row, ri) => {
        html += "<tr>";
        row.forEach((cell, ci) => {
            let cls = (cell == "**") ? "blank" : "";
            if(activePattern && activePattern.points.some(p => p.r == ri && p.c == ci)) cls += " circle";
            if(activePattern && activePattern.baseR == ri && activePattern.baseC == ci) cls += " base-mark";
            html += `<td class="${cls}" contenteditable="${cell!='**'}" oninput="update(${ri},${ci},this)" onclick="${cell=='**'?`runScan(${ri},${ci})`:''}"> ${cell} </td>`;
        });
        html += "</tr>";
    });
    document.getElementById("mainTable").innerHTML = html;
    if(activePattern) setTimeout(drawLines, 50);
}

function runScan(r, c) {
    let baseJodi = ""; let bRow = -1;
    for(let i=r-1; i>=0; i--) { if(chartData[i][c] != "**") { baseJodi=chartData[i][c]; bRow=i; break; } }
    if(bRow == -1) return;

    let fam = getFamily(baseJodi);
    let matches = [];
    
    for(let i=0; i < r - 1; i++) {
        if(fam.includes(chartData[i][c])) {
            let pts = [{r: i, c: c}];
            // Vertical Check
            if(chartData[i-1] && chartData[r-1] && getFamily(chartData[r-1][c]).includes(chartData[i-1][c])) {
                pts.push({r: i-1, c: c});
            }
            matches.push({index: i, points: pts, baseR: i, baseC: c, targetCol: c});
        }
    }
    showMatches(matches);
}

function showMatches(matches) {
    let list = document.getElementById("checks");
    list.innerHTML = matches.length ? "" : "No Pattern Found";
    matches.slice(0, 5).forEach((m, idx) => {
        let div = document.createElement("div");
        div.innerHTML = `‚≠ê Master Match #${idx+1} at Row ${m.index + 1}`;
        div.onclick = () => {
            activePattern = m;
            render();
            let nextVal = chartData[m.index + 1] ? chartData[m.index + 1][m.targetCol] : "??";
            document.getElementById("futureJodi").innerText = nextVal;
            document.getElementById("aiReport").innerHTML = `Found Table Trick connection from Row ${m.index+1}. The movement suggests <b>${nextVal}</b> is a strong candidate.`;
        };
        list.appendChild(div);
    });
}

function drawLines() {
    const cvs = document.getElementById("mainCanvas");
    const tbl = document.getElementById("mainTable");
    const ctx = cvs.getContext("2d");
    cvs.width = tbl.offsetWidth; cvs.height = tbl.offsetHeight;
    ctx.clearRect(0,0,cvs.width,cvs.height);
    let rect = tbl.getBoundingClientRect();
    let targets = document.querySelectorAll(".circle, .base-mark");
    if(targets.length < 2) return;
    let base = document.querySelector(".base-mark").getBoundingClientRect();
    ctx.strokeStyle = "rgba(0, 123, 255, 0.8)"; ctx.lineWidth = 2.5;
    targets.forEach(t => {
        let r = t.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(base.left - rect.left + base.width/2, base.top - rect.top + base.height/2);
        ctx.lineTo(r.left - rect.left + r.width/2, r.top - rect.top + r.height/2);
        ctx.stroke();
    });
}

// Fixed CSV Loader
document.getElementById("csvFile").onchange = e => {
    let fr = new FileReader();
    fr.onload = () => {
        let raw = fr.result.replace(/\./g, ",").replace(/\t/g, ",");
        let rows = raw.split("\n").filter(l => l.trim());
        chartData = rows.map(r => {
            let cols = r.split(",").map(v => norm(v));
            while(cols.length < 6) cols.push("**");
            return cols.slice(0, 6);
        });
        localStorage.setItem(DB_KEY, JSON.stringify(chartData));
        render();
        alert("Data Loaded Successfully!");
    };
    fr.readAsText(e.target.files[0]);
};

function update(r, c, el) { chartData[r][c] = norm(el.innerText); }
function addRow() { chartData.push(["**","**","**","**","**","**"]); render(); }
function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(chartData)); alert("Saved!"); }
function clearData() { if(confirm("Reset everything?")) { localStorage.clear(); location.reload(); } }

render();
</script>
</body>
</html>
