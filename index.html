<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Matka Advanced Pattern Logic</title>
    <style>
        :root { --gold: #ffd700; --bg: #121212; --panel: #1e1e1e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        
        /* Search Box Styles */
        .search-section { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid #444; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        input, select { padding: 10px; border-radius: 5px; border: 1px solid #555; background: #333; color: white; }
        
        /* Table Styles */
        .table-container { background: white; border-radius: 10px; overflow-x: auto; position: relative; }
        table { width: 100%; border-collapse: collapse; color: black; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; font-weight: bold; position: relative; }
        th { background: #800000; color: white; }

        /* Marking Styles */
        .jodi-cell { display: inline-block; width: 40px; height: 40px; line-height: 40px; cursor: pointer; transition: 0.2s; position: relative; z-index: 2; }
        .base-jodi-mark { border: 3px solid #ff0000; background: rgba(255, 0, 0, 0.1); border-radius: 5px; } /* Chokor üî≥ */
        .pattern-circle { border: 3px solid #0000ff; border-radius: 50%; } /* Round ‚≠ï */
        
        /* Connection Line (Canvas Layer) */
        #lineCanvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1; }

        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-save { background: #28a745; color: white; }
        .btn-upload { background: var(--gold); color: black; }
    </style>
</head>
<body>

<div class="container">
    <div class="search-section">
        <div>
            <label>Market:</label><br>
            <select id="marketSelect">
                <option>Kalyan</option><option>Rajdhani</option><option>Milan</option>
            </select>
        </div>
        <div>
            <label>Select Day:</label><br>
            <select id="daySelect">
                <option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option>
                <option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option>
            </select>
        </div>
        <div>
            <label>Base Jodis:</label><br>
            <input type="text" id="baseJodi1" placeholder="Jodi 1" style="width:50px">
            <input type="text" id="baseJodi2" placeholder="Jodi 2" style="width:50px">
        </div>
        <div>
            <label>Search Rows (Up):</label><br>
            <input type="number" id="rowRange" value="8" style="width:60px">
        </div>
        <div style="display:flex; align-items:flex-end;">
            <button class="btn btn-save" onclick="runPatternSearch()">Run Pattern</button>
        </div>
    </div>

    <div class="controls" style="margin-bottom:10px;">
        <input type="file" id="csvFile" hidden onchange="handleCSV(this.files)">
        <button class="btn btn-upload" onclick="document.getElementById('csvFile').click()">üìÇ Upload CSV</button>
        <button class="btn" style="background:#007bff; color:white;" onclick="addNewRow()">‚ûï Add Row</button>
        <button class="btn" style="background:#ff4d4d; color:white;" onclick="clearData()">üóëÔ∏è Clear Data</button>
    </div>

    <div class="table-container" id="tableWrapper">
        <canvas id="lineCanvas"></canvas>
        <table id="mainTable">
            <thead>
                <tr>
                    <th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const tableBody = document.getElementById('tableBody');

    // 1. Padding Logic (01, 02...)
    function formatJodi(val) {
        val = val.toString().trim();
        if(val.length === 1) return "0" + val;
        return val || "00";
    }

    // 2. Family Jodi Logic
    function getFamily(jodi) {
        if(!jodi || jodi == "00") return [];
        let a = parseInt(jodi[0]), b = parseInt(jodi[1]);
        let cut = (n) => (n + 5) % 10;
        let fam = [
            `${a}${b}`, `${cut(a)}${b}`, `${a}${cut(b)}`, `${cut(a)}${cut(b)}`,
            `${b}${a}`, `${cut(b)}${a}`, `${b}${cut(a)}`, `${cut(b)}${cut(a)}`
        ];
        return [...new Set(fam)];
    }

    // 3. Local Storage & Add Row
    function addNewRow(data = ["NEW", "00", "00", "00", "00", "00", "00"]) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input type="text" value="${data[0]}" onchange="saveAll()"></td>`;
        for(let i=1; i<=6; i++) {
            let val = formatJodi(data[i]);
            tr.innerHTML += `<td><span class="jodi-cell" data-col="${i}">${val}</span></td>`;
        }
        tableBody.prepend(tr); // Niche se start (Newest top, search bottom to up)
        saveAll();
    }

    // 4. Pattern Search Logic
    function runPatternSearch() {
        // Reset markings
        document.querySelectorAll('.jodi-cell').forEach(el => el.className = 'jodi-cell');
        
        let targetDay = document.getElementById('daySelect').value;
        let baseJ1 = formatJodi(document.getElementById('baseJodi1').value);
        let range = parseInt(document.getElementById('rowRange').value);
        
        let rows = Array.from(tableBody.querySelectorAll('tr'));
        
        // Niche se start search (Bottom-up)
        for(let i = rows.length - 1; i >= 0; i--) {
            let cell = rows[i].children[targetDay].querySelector('.jodi-cell');
            let jodiVal = cell.innerText;

            if(jodiVal === baseJ1) {
                cell.classList.add('base-jodi-mark'); // Chokor üî≥
                
                // Check rows above for family
                let family = getFamily(baseJ1);
                for(let r = 1; r <= range; r++) {
                    if(i - r >= 0) {
                        let rowToSearch = rows[i - r];
                        Array.from(rowToSearch.querySelectorAll('.jodi-cell')).forEach(c => {
                            if(family.includes(c.innerText)) {
                                c.classList.add('pattern-circle'); // Round ‚≠ï
                            }
                        });
                    }
                }
            }
        }
    }

    // 5. Data Persistence
    function saveAll() {
        let data = [];
        tableBody.querySelectorAll('tr').forEach(tr => {
            let rowData = [tr.querySelector('input').value];
            tr.querySelectorAll('.jodi-cell').forEach(span => rowData.push(span.innerText));
            data.push(rowData);
        });
        localStorage.setItem('matkaData', JSON.stringify(data));
    }

    function loadData() {
        let stored = localStorage.getItem('matkaData');
        if(stored) {
            tableBody.innerHTML = "";
            JSON.parse(stored).reverse().forEach(row => addNewRow(row));
        }
    }

    function handleCSV(files) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n');
            tableBody.innerHTML = "";
            lines.forEach(line => { if(line.trim()) addNewRow(line.split(',')); });
        };
        reader.readAsText(files[0]);
    }

    function clearData() { if(confirm("Clear everything?")) { localStorage.clear(); location.reload(); } }

    window.onload = loadData;
</script>

</body>
</html>
