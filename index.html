<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPBOSS KING PATTERN SEARCHER</title>
    <style>
        :root { --red: #ff0000; --blue: #1e90ff; --gold: #ffd700; --bg: #f8f9fa; --header: #800000; }
        body { background: #000; color: #fff; font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 0; }
        
        /* Top Navigation Bar */
        .header { background: var(--header); padding: 15px; border-bottom: 3px solid var(--gold); text-align: center; }
        .header h1 { margin: 0; font-size: 24px; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; }

        /* Toolbar Section */
        .controls { background: #222; padding: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        button { padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-csv { background: #fff; color: #000; }
        .btn-reset { background: var(--red); color: #fff; }
        .btn-save { background: #28a745; color: #fff; }

        /* The Main Chart Area - Exactly like dpbossking.in */
        .chart-box { position: relative; display: inline-block; margin: 20px auto; background: #fff; padding: 8px; border: 4px solid #555; }
        table { border-collapse: collapse; background: #fff; color: #000; min-width: 360px; border: 2px solid #000; }
        th, td { border: 1px solid #000; width: 60px; height: 55px; text-align: center; font-weight: bold; font-size: 22px; position: relative; cursor: crosshair; }
        th { background: #f0f0f0; font-size: 12px; height: 35px; color: #000; }

        /* Markers & Lines */
        .base-node::after { content: ''; position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; border: 4px solid var(--red); border-radius: 50%; box-sizing: border-box; }
        .pattern-node::after { content: ''; position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; border: 4px solid var(--blue); border-radius: 50%; box-sizing: border-box; }
        #svgOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* Analysis Panel */
        .analysis { max-width: 900px; margin: 20px auto; background: #111; border: 1px solid var(--gold); border-radius: 8px; overflow: hidden; }
        .analysis-header { background: #333; color: var(--gold); padding: 10px; font-weight: bold; border-bottom: 2px solid var(--gold); }
        .match-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #222; background: #1a1a1a; }
        .match-jodi { color: var(--gold); font-size: 32px; font-weight: 900; }
        .match-info { color: #888; font-size: 14px; }
        #status { padding: 10px; color: #0f0; font-weight: bold; text-align: center; background: #001a00; border-bottom: 1px solid #0f0; }
    </style>
</head>
<body>

    <div class="header"><h1>DPKING MASTER PATTERN SEARCHER</h1></div>
    <div id="status">Ready: Click Base Number to Start</div>

    <div class="controls">
        <input type="file" id="fileIn" accept=".csv" style="display:none">
        <button class="btn-csv" onclick="document.getElementById('fileIn').click()">Upload Record</button>
        <button class="btn-save" onclick="saveToLocal()">Save Chart</button>
        <button class="btn-reset" onclick="resetEngine()">Full Reset</button>
    </div>

    <div style="text-align: center;">
        <div class="chart-box" id="chartParent">
            <svg id="svgOverlay"></svg>
            <table id="targetChart"></table>
        </div>
    </div>

    <div class="analysis">
        <div class="analysis-header">SURE LINE ANALYSIS (HISTORY MATCHES)</div>
        <div id="resultBox">
            <div style="padding: 20px; color: #666;">Patterns select karne ke baad results yahan aayenge...</div>
        </div>
    </div>

    <script>
        // Data & Logic Setup
        let chartData = JSON.parse(localStorage.getItem('DP_KING_PRO')) || Array(15).fill().map(() => Array(6).fill("**"));
        let baseNode = null;
        let pNodes = [];

        const families = {"11":["11","16","61","66"],"22":["22","27","72","77"],"33":["33","38","83","88"],"44":["44","49","94","99"],"55":["00","05","50","55"],"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"]};
        function getFamily(v){ let s=String(v).trim(); for(let f in families) if(families[f].includes(s)) return f; return s; }

        function renderChart() {
            let html = `<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>`;
            chartData.forEach((row, r) => {
                html += `<tr>`;
                row.forEach((val, c) => {
                    let cls = "";
                    if(baseNode && baseNode.r === r && baseNode.c === c) cls = "base-node";
                    if(pNodes.some(p => p.r === r && p.c === c)) cls = "pattern-node";
                    html += `<td id="cell-${r}-${c}" class="${cls}" contenteditable="true" onblur="updateVal(${r},${c},this.innerText)" onclick="handleNode(${r},${c})">${val}</td>`;
                });
                html += `</tr>`;
            });
            document.getElementById("targetChart").innerHTML = html;
            setTimeout(drawVisualLines, 50);
        }

        function handleNode(r, c) {
            let val = chartData[r][c];
            if(!baseNode && val !== "**") {
                baseNode = { r, c, fam: getFamily(val), col: c };
                document.getElementById("status").innerText = "BASE JODI FIXED. SELECT PATTERN STRUCTURE.";
            } else if(baseNode && val !== "**") {
                if(r === baseNode.r && c === baseNode.c) return;
                pNodes.push({ r, c, dr: r - baseNode.r, dc: c - baseNode.c, fam: getFamily(val) });
            } else if(baseNode && (val === "**" || val === "")) {
                processSearch(r, c);
            }
            renderChart();
        }

        function drawVisualLines() {
            const svg = document.getElementById("svgOverlay");
            svg.innerHTML = "";
            if(!baseNode || pNodes.length === 0) return;
            const b = document.getElementById(`cell-${baseNode.r}-${baseNode.c}`);
            pNodes.forEach(p => {
                const target = document.getElementById(`cell-${p.r}-${p.c}`);
                if(b && target) {
                    let line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", b.offsetLeft + b.offsetWidth/2);
                    line.setAttribute("y1", b.offsetTop + b.offsetHeight/2);
                    line.setAttribute("x2", target.offsetLeft + target.offsetWidth/2);
                    line.setAttribute("y2", target.offsetTop + target.offsetHeight/2);
                    line.setAttribute("stroke", "rgba(30, 144, 255, 0.5)");
                    line.setAttribute("stroke-width", "3");
                    svg.appendChild(line);
                }
            });
        }

        function processSearch(tr, tc) {
            let drB = tr - baseNode.r, dcB = tc - baseNode.c;
            let results = [];

            chartData.forEach((row, i) => {
                row.forEach((val, j) => {
                    // Search by Fixed Column & Family Match
                    if(j === baseNode.col && getFamily(val) === baseNode.fam && i !== baseNode.r) {
                        let isStructureMatch = pNodes.every(p => {
                            let checkR = i + p.dr, checkC = j + p.dc;
                            return chartData[checkR] && getFamily(chartData[checkR][checkC]) === p.fam;
                        });

                        if(isStructureMatch) {
                            let resVal = chartData[i + drB] ? chartData[i + drB][j + dcB] : null;
                            if(resVal && resVal !== "**") {
                                results.push({ v: resVal, row: i + drB + 1 });
                            }
                        }
                    }
                });
            });

            const resDiv = document.getElementById("resultBox");
            resDiv.innerHTML = results.length ? results.map(m => `
                <div class="match-row">
                    <div class="match-info">Matched Line from Row: ${m.row}</div>
                    <div class="match-jodi">${m.v}</div>
                </div>
            `).join('') : "<div style='padding:20px;'>No Pattern Found in History.</div>";
        }

        function updateVal(r, c, v) { chartData[r][c] = v.trim() || "**"; }
        function saveToLocal() { localStorage.setItem('DP_KING_PRO', JSON.stringify(chartData)); alert("Data Saved!"); }
        function resetEngine() { baseNode = null; pNodes = []; renderChart(); document.getElementById("status").innerText = "Ready"; }

        document.getElementById('fileIn').addEventListener('change', function(e){
            const reader = new FileReader();
            reader.onload = (ev) => {
                chartData = ev.target.result.split(/\r?\n/).filter(l=>l.trim()).map(l=>{
                    let c = l.split(','); while(c.length<6) c.push("**"); return c.slice(0,6).map(x=>x.trim()||"**");
                });
                renderChart();
            };
            reader.readAsText(e.target.files[0]);
        });

        window.onresize = renderChart;
        renderChart();
    </script>
</body>
</html>
