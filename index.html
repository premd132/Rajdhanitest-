<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rajdhani AI â€“ Position Pattern Pro</title>
<style>
    :root { --gold: #ffd700; --bg: #121212; --panel: #1e1e1e; }
    body { font-family: 'Segoe UI', Arial; background: var(--bg); color: #fff; margin: 0; padding: 10px; }
    
    h2 { color: var(--gold); text-align: center; text-transform: uppercase; margin: 10px 0; font-size: 1.2rem; }
    
    table { border-collapse: collapse; background: #fff; color: #000; width: 100%; max-width: 800px; margin: 0 auto; text-align: center; }
    th, td { border: 1px solid #999; width: 45px; height: 45px; font-weight: bold; font-size: 14px; cursor: pointer; }
    th { background: #800000; color: #fff; }
    
    .selected-base { background: #4CAF50 !important; color: white !important; border: 3px solid #000; }
    .pattern-member { border: 2.5px solid blue; border-radius: 50%; background: rgba(0,0,255,0.1); }
    .blank { background: #f0f0f0; color: #999; }
    
    .card { background: var(--panel); border-left: 5px solid var(--gold); padding: 12px; border-radius: 5px; margin-top: 15px; }
    button { background: var(--gold); border: none; padding: 10px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; margin: 5px; }
    
    #checks div { background: #333; padding: 12px; margin-top: 8px; border-radius: 4px; border: 1px solid #555; }
    #popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 15px; border-radius: 8px; display: none; z-index: 1000; width: 95%; max-width: 500px; box-shadow: 0 0 30px #000; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; z-index: 900; }
</style>
</head>
<body>

<h2>RAJDHANI POSITION SYSTEM</h2>

<div style="text-align:center; margin-bottom:15px;">
    <button onclick="addRow()">+ Add Row</button>
    <button onclick="saveData()">Save Data</button>
    <button onclick="resetAll()" style="background:red; color:white;">Reset</button>
</div>

<table id="mainTable"></table>

<div class="card">
    <h3 style="margin:0; color:var(--gold)">How to use:</h3>
    <ol style="font-size:13px; margin:5px 0;">
        <li>Ek <b>Jodi</b> par click karein jo aapki <b>Base</b> hai (e.g. 47).</li>
        <li>Uske aas-paas ki un jodis par click karein jo pattern bana rahi hain (Blue mark hongi).</li>
        <li>Sabse niche kisi bhi <b>Blank (**)</b> par click karein search ke liye.</li>
    </ol>
</div>

<div class="card">
    <h3 style="margin:0; color:var(--gold)">Matching Patterns:</h3>
    <div id="checks">Select Base and Pattern members first.</div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <div id="popContent"></div>
    <button onclick="closePopup()" style="width:100%; margin-top:10px;">Close</button>
</div>

<script>
const STORAGE_KEY = "pos_system_v4";
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || Array(20).fill().map(() => Array(6).fill("**"));
let basePos = null; 
let patternOffsets = []; // {dr, dc, family}

function renderTable() {
    const table = document.getElementById("mainTable");
    let html = `<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>`;
    data.forEach((row, r) => {
        html += `<tr>`;
        row.forEach((val, c) => {
            let cls = val === "**" ? "blank" : "";
            if(basePos && basePos.r === r && basePos.c === c) cls += " selected-base";
            let isPattern = patternOffsets.some(p => (basePos.r + p.dr === r) && (basePos.c + p.dc === c));
            if(isPattern) cls += " pattern-member";
            
            html += `<td class="${cls}" onclick="handleCellClick(${r}, ${c}, '${val}')" contenteditable="${val!=='**'}" onblur="editCell(${r},${c},this.innerText)">${val}</td>`;
        });
        html += `</tr>`;
    });
    table.innerHTML = html;
}

// Family Map
const families = { "11":["11","16","61","66"], "22":["22","27","72","77"], "33":["33","38","83","88"], "44":["44","49","94","99"], "55":["00","05","50","55"], "12":["12","17","21","26","62","67","71","76"], "13":["13","18","31","36","63","68","81","86"], "14":["14","19","41","46","64","69","91","96"], "15":["01","06","10","15","51","56","60","65"], "23":["23","28","32","37","73","78","82","87"], "24":["24","29","42","47","74","79","92","97"], "25":["02","07","20","25","52","57","70","75"], "34":["34","39","43","48","84","89","93","98"], "35":["03","08","30","35","53","58","80","85"], "45":["04","09","40","45","54","59","90","95"] };
function getFam(v) { for(let k in families) if(families[k].includes(v)) return k; return v; }

function handleCellClick(r, c, val) {
    if(val !== "**") {
        if(!basePos) {
            basePos = {r, c, val, fam: getFam(val)};
        } else {
            // Add or Remove from Pattern Position
            let dr = r - basePos.r;
            let dc = c - basePos.c;
            let index = patternOffsets.findIndex(p => p.dr === dr && p.dc === dc);
            if(index > -1) patternOffsets.splice(index, 1);
            else patternOffsets.push({dr, dc, fam: getFam(val)});
        }
        renderTable();
    } else if(basePos && patternOffsets.length > 0) {
        searchPositionMatch(r, c);
    }
}

function searchPositionMatch(targetR, targetC) {
    let results = [];
    let relToTargetR = targetR - basePos.r;
    let relToTargetC = targetC - basePos.c;

    for(let i=0; i < data.length; i++) {
        for(let j=0; j < 6; j++) {
            // 1. Base Jodi ki family match honi chahiye
            if(getFam(data[i][j]) === basePos.fam) {
                
                // 2. Check if all other pattern positions have "any" family but in "same position"
                let matchScore = 0;
                patternOffsets.forEach(p => {
                    let checkR = i + p.dr;
                    let checkC = j + p.dc;
                    if(data[checkR] && data[checkR][checkC] !== "**") {
                        // Agar aap chahte hain ki family bhi same ho toh ye line use karein:
                        // if(getFam(data[checkR][checkC]) === p.fam) matchScore++;
                        matchScore++; // Abhi sirf position check kar raha hai
                    }
                });

                if(matchScore === patternOffsets.length) {
                    let predR = i + relToTargetR;
                    let predC = j + relToTargetC;
                    if(data[predR] && data[predR][predC] !== "**") {
                        results.push({base: {r:i, c:j, val:data[i][j]}, pred: data[predR][predC], predR, predC});
                    }
                }
            }
        }
    }
    displayResults(results, relToTargetR, relToTargetC);
}

function displayResults(res) {
    const div = document.getElementById("checks");
    div.innerHTML = res.length ? "" : "No position matches found.";
    res.forEach(item => {
        let d = document.createElement("div");
        d.innerHTML = `Match at Row ${item.base.r+1} | Jodi: <b style="color:var(--gold); font-size:18px;">${item.pred}</b>`;
        d.onclick = () => showPreview(item);
        div.appendChild(d);
    });
}

function showPreview(item) {
    let html = `<table style="width:100%">`;
    for(let i=item.base.r-2; i<=item.base.r+5; i++) {
        if(!data[i]) continue;
        html += `<tr>`;
        data[i].forEach((v, j) => {
            let style = "";
            if(i === item.base.r && j === item.base.c) style = "selected-base";
            if(i === item.predR && j === item.predC) style = "background:yellow;";
            html += `<td class="${style}">${v}</td>`;
        });
        html += `</tr>`;
    }
    html += `</table>`;
    document.getElementById("popContent").innerHTML = html;
    document.getElementById("popup").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function editCell(r,c,v) { data[r][c] = v.trim(); }
function addRow() { data.push(Array(6).fill("**")); renderTable(); }
function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); alert("Saved!"); }
function resetAll() { basePos = null; patternOffsets = []; renderTable(); }
function closePopup() { document.getElementById("popup").style.display="none"; document.getElementById("overlay").style.display="none"; }

renderTable();
</script>
</body>
</html>
