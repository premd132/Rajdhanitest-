<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPBOSS MASTER - VISUAL CHECK LINE</title>
    <style>
        :root { --gold: #ffd700; --red: #ff3333; --blue: #007bff; --bg: #0b0b0b; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; margin: 0; padding: 10px; }
        .header { text-align: center; border-bottom: 2px solid var(--gold); padding: 5px; }
        .toolbar { display: flex; justify-content: center; gap: 8px; margin: 15px 0; }
        button { padding: 8px 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        
        .chart-box { position: relative; overflow-x: auto; margin-top: 10px; }
        table { border-collapse: collapse; background: #fff; color: #000; width: 100%; max-width: 900px; margin: 0 auto; z-index: 2; position: relative; }
        th, td { border: 1px solid #999; height: 50px; text-align: center; font-weight: bold; font-size: 18px; position: relative; min-width: 60px; }
        th { background: #800000; color: #fff; font-size: 12px; }

        /* Highlights */
        .base-jodi { background: #ffcdd2 !important; border: 3px solid var(--red) !important; color: var(--red); }
        .pattern-circle::after { content: ''; position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; border: 3px solid var(--blue); border-radius: 50%; pointer-events: none; }
        
        /* Check Line Canvas */
        #lineCanvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 5; width: 100%; height: 100%; }

        /* Popup */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; border: 2px solid var(--gold); padding: 20px; z-index: 1000; width: 85%; max-width: 400px; border-radius: 10px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; }
    </style>
</head>
<body>

    <div class="header">
        <h1>DPBOSS PATTERN MASTER</h1>
        <div id="status" style="color:var(--gold)">Select Base Jodi</div>
    </div>

    <div class="toolbar">
        <input type="file" id="csvIn" accept=".csv" style="display:none">
        <button onclick="document.getElementById('csvIn').click()">Upload CSV</button>
        <button onclick="resetSys()" style="background:var(--red); color:#fff;">Reset All</button>
    </div>

    <div class="chart-box" id="chartContainer">
        <svg id="lineCanvas"></svg>
        <table id="mainChart"></table>
    </div>

    <div id="modal" class="modal">
        <h2 style="color:var(--gold)">Check Line Result</h2>
        <div id="modalContent" style="font-size: 18px;"></div>
        <button onclick="closeModal()" style="width:100%; margin-top:15px; background:var(--gold);">Close</button>
    </div>
    <div id="overlay" class="overlay" onclick="closeModal()"></div>

    <script>
        const KEY = "MASTER_V10";
        let data = JSON.parse(localStorage.getItem(KEY)) || Array(15).fill().map(() => Array(6).fill("**"));
        let base = null;
        let patternNodes = [];

        const fams = {"11":["11","16","61","66"],"22":["22","27","72","77"],"33":["33","38","83","88"],"44":["44","49","94","99"],"55":["00","05","50","55"],"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"]};
        function getFam(v){ let s=String(v).trim(); for(let f in fams) if(fams[f].includes(s)) return f; return s; }

        function render() {
            let html = `<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>`;
            data.forEach((row, r) => {
                html += `<tr>`;
                row.forEach((val, c) => {
                    let cls = "";
                    if(base && base.r === r && base.c === c) cls = "base-jodi";
                    if(patternNodes.some(p => p.r === r && p.c === c)) cls = "pattern-circle";
                    html += `<td id="cell-${r}-${c}" class="${cls}" onclick="handleCell(${r},${c})">${val}</td>`;
                });
                html += `</tr>`;
            });
            document.getElementById("mainChart").innerHTML = html;
            drawLines();
        }

        function handleCell(r, c) {
            let val = data[r][c];
            if(!base && val !== "**") {
                base = { r, c, day: c, fam: getFam(val) };
                document.getElementById("status").innerText = "Base Fixed. Select Cross Lines.";
            } else if(base && val !== "**") {
                if(r === base.r && c === base.c) return;
                patternNodes.push({ r, c, dr: r - base.r, dc: c - base.c, fam: getFam(val) });
            } else if(base && val === "**") {
                searchHistory(r, c);
            }
            render();
        }

        function drawLines() {
            const svg = document.getElementById("lineCanvas");
            svg.innerHTML = ""; 
            if(!base || patternNodes.length === 0) return;

            const bCell = document.getElementById(`cell-${base.r}-${base.c}`);
            patternNodes.forEach(p => {
                const pCell = document.getElementById(`cell-${p.r}-${p.c}`);
                if(bCell && pCell) {
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", bCell.offsetLeft + bCell.offsetWidth/2);
                    line.setAttribute("y1", bCell.offsetTop + bCell.offsetHeight/2);
                    line.setAttribute("x2", pCell.offsetLeft + pCell.offsetWidth/2);
                    line.setAttribute("y2", pCell.offsetTop + pCell.offsetHeight/2);
                    line.setAttribute("stroke", "rgba(0, 123, 255, 0.7)");
                    line.setAttribute("stroke-width", "3");
                    svg.appendChild(line);
                }
            });
        }

        function searchHistory(tr, tc) {
            let results = [];
            let drB = tr - base.r, dcB = tc - base.c;

            for(let i=0; i < data.length; i++) {
                for(let j=0; j < 6; j++) {
                    if(j === base.day && getFam(data[i][j]) === base.fam && i !== base.r) {
                        let match = patternNodes.every(p => {
                            let rP = i + p.dr, cP = j + p.dc;
                            return data[rP] && getFam(data[rP][cP]) === p.fam;
                        });
                        if(match) {
                            let resVal = data[i+drB] ? data[i+drB][j+dcB] : null;
                            if(resVal && resVal !== "**") results.push({v: resVal, r: i+drB+1});
                        }
                    }
                }
            }
            showPopup(results);
        }

        function showPopup(res) {
            const out = document.getElementById("modalContent");
            out.innerHTML = res.length ? res.map(m => `<div style="padding:10px; border-bottom:1px solid #444;">Strong Line Jodi: <b style="color:var(--gold); font-size:24px;">${m.v}</b> (Row ${m.r})</div>`).join('') : "No strong check lines found.";
            document.getElementById("modal").style.display = "block";
            document.getElementById("overlay").style.display = "block";
        }

        function closeModal() { document.getElementById("modal").style.display="none"; document.getElementById("overlay").style.display="none"; }
        function resetSys() { base = null; patternNodes = []; render(); document.getElementById("status").innerText = "Select Base Jodi"; }

        // Local CSV Loading Support
        document.getElementById('csvIn').addEventListener('change', function(e){
            const reader = new FileReader();
            reader.onload = function(ev){
                data = ev.target.result.split(/\r?\n/).filter(l=>l.trim()).map(l=> {
                    let c = l.split(','); while(c.length<6) c.push("**"); return c.slice(0,6).map(x=>x.trim()||"**");
                });
                render();
            };
            reader.readAsText(e.target.files[0]);
        });

        window.onresize = render; // Re-draw lines on screen resize
        render();
    </script>
</body>
</html>
