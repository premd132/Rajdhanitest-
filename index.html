<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Jodi Same Column Pattern â€“ FINAL</title>
<style>
body{font-family:Arial;background:#f6f1d3;padding:10px}
.controls{margin-bottom:8px}
table{border-collapse:collapse}
th,td{
  border:1px solid #999;
  width:55px;height:32px;
  text-align:center;
  font-weight:700;
  background:#fbf6db;
  position:relative;
}
th{background:#eee}
.square{outline:3px solid #000}
.circle{border:3px solid #1e5bff;border-radius:50%}
svg{position:absolute;top:0;left:0;pointer-events:none}
button{margin-left:5px}
</style>
</head>
<body>

<div class="controls">
Market:
<select>
  <option>Kalyan</option>
  <option>Rajdhani</option>
  <option>Milan</option>
</select>

Day:
<select id="day">
  <option value="0">Mon</option>
  <option value="1">Tue</option>
  <option value="2">Wed</option>
  <option value="3">Thu</option>
  <option value="4">Fri</option>
  <option value="5">Sat</option>
</select>

Base Jodi:
<input id="base" value="20" size="3">

Rows:
<select id="rows"></select>

<button onclick="search()">SEARCH</button>
<button onclick="clearMarks()">Clear</button>
</div>

<div class="controls">
CSV:
<input type="file" id="csv">
<button onclick="upload()">Upload</button>
<button onclick="addRow()">Add Row</button>
</div>

<div id="wrap" style="position:relative">
<svg id="lines"></svg>
<table>
<thead>
<tr>
<th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script>
// ================= FAMILY =================
const FAMILIES={
"12":["12","17","21","26","62","67","71","76"],
"13":["13","18","31","36","63","68","81","86"],
"14":["14","19","41","46","64","69","91","96"],
"15":["01","06","10","15","51","56","60","65"],
"23":["23","28","32","37","73","78","82","87"],
"24":["24","29","42","47","74","79","92","97"],
"25":["02","07","20","25","52","57","70","75"],
"34":["34","39","43","48","84","89","93","98"],
"35":["03","08","30","35","53","58","80","85"],
"45":["04","09","40","45","54","59","90","95"],
"half":["05","16","27","38","49","50","61","72","83","94"],
"full":["00","11","22","33","44","55","66","77","88","99"]
};

// ================= UTIL =================
const pad=v=>{
 if(v==="**") return "**";
 v=String(v).replace(/[^0-9]/g,"");
 if(v==="") return "**";
 return v.length===1 ? "0"+v : v.slice(-2);
};
const palti=v=>v[1]+v[0];
const familyOf=v=>{
 for(let k in FAMILIES) if(FAMILIES[k].includes(v)) return k;
 return null;
};
const isMatch=(base,v)=>{
 if(v==="**") return false;
 if(v===base) return true;
 if(palti(v)===base) return true;
 let f=familyOf(base);
 return f && FAMILIES[f].includes(v);
};

// ================= DATA =================
let data=[];
const tbody=document.getElementById("tbody");

// rows selector
for(let i=1;i<=10;i++){
 let o=document.createElement("option");
 o.value=i; o.text=i;
 rows.appendChild(o);
}

// ================= STORAGE =================
function save(){localStorage.setItem("jodiData",JSON.stringify(data))}
function load(){
 let d=localStorage.getItem("jodiData");
 if(d){data=JSON.parse(d); render()}
}
load();

// ================= CSV UPLOAD =================
function upload(){
csv.onchange=e=>{
 let fr=new FileReader();
 fr.onload=()=>{
  let rows=fr.result.replace(/\r/g,"").trim().split("\n");
  if(rows[0].toLowerCase().includes("mon")) rows.shift();
  data=rows.map(r=>r.split(",").map(v=>{
    v=v.trim(); if(v==""||v=="*"||v=="**") return "**"; return norm(v);
  }));
  localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
  draw();
 };
 fr.readAsText(e.target.files[0]);
};

  r.readAsText(f);
}

// ================= TABLE =================
function render(){
 tbody.innerHTML="";
 data.forEach((r,ri)=>{
  let tr=document.createElement("tr");
  r.forEach((v,ci)=>{
    let td=document.createElement("td");
    td.textContent=v;
    td.dataset.r=ri; td.dataset.c=ci;
    td.contentEditable=true;
    td.oninput=()=>{
      data[ri][ci]=pad(td.textContent);
      save(); render();
    };
    tr.appendChild(td);
  });
  tbody.appendChild(tr);
 });
 resizeSVG();
}

function addRow(){
 data.push(["**","**","**","**","**","**"]);
 save(); render();
}

// ================= SEARCH =================
function search(){
 clearMarks();
 let base=pad(baseInput.value);
 let col=parseInt(day.value);
 let R=parseInt(rows.value);

 for(let r=data.length-1;r>=0;r--){
  if(data[r][col]===base){
    markSquare(r,col);
    let hits=[];
    for(let k=1;k<=R;k++){
      let rr=r-k; if(rr<0) break;
      if(isMatch(base,data[rr][col])){
        hits.push(rr);
        markCircle(rr,col);
      }
    }
    if(hits.length>1) drawLine(hits,col);
  }
 }
}

// ================= DRAW =================
function cell(r,c){
 return document.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
}
function markSquare(r,c){cell(r,c).classList.add("square")}
function markCircle(r,c){cell(r,c).classList.add("circle")}

function drawLine(rows,col){
 for(let i=0;i<rows.length-1;i++){
  let a=cell(rows[i],col).getBoundingClientRect();
  let b=cell(rows[i+1],col).getBoundingClientRect();
  let box=lines.getBoundingClientRect();
  let l=document.createElementNS("http://www.w3.org/2000/svg","line");
  l.setAttribute("x1",a.left+a.width/2-box.left);
  l.setAttribute("y1",a.top+a.height/2-box.top);
  l.setAttribute("x2",b.left+b.width/2-box.left);
  l.setAttribute("y2",b.top+b.height/2-box.top);
  l.setAttribute("stroke","blue");
  l.setAttribute("stroke-width","2");
  lines.appendChild(l);
 }
}

// ================= CLEAR =================
function clearMarks(){
 document.querySelectorAll(".square,.circle").forEach(e=>{
  e.classList.remove("square","circle");
 });
 lines.innerHTML="";
}
function resizeSVG(){
 let t=document.querySelector("table").getBoundingClientRect();
 lines.setAttribute("width",t.width);
 lines.setAttribute("height",t.height);
}
</script>

</body>
</html>
