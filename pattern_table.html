<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pattern Table System</title>

<style>
body{
  font-family: Arial;
  background:#f5f5f5;
}
h2{margin:5px 0}

table{
  border-collapse:collapse;
  background:#fff;
  font-size:13px;
}
th,td{
  border:1px solid #999;
  padding:6px;
  text-align:center;
  min-width:40px;
  font-weight:600;
}
td[contenteditable]{
  background:#fffbe6;
  cursor:text;
}
.blank{
  background:#eee;
  cursor:pointer;
}
.circle{
  border:3px solid red !important;
  border-radius:50%;
}
.line-vert{
  box-shadow: inset 0 -4px red;
}
.line-diag{
  background:
   linear-gradient(135deg, transparent 45%, red 46%, red 54%, transparent 55%);
}
.controls{
  margin-bottom:10px;
}
button{
  padding:6px 10px;
  margin-right:5px;
}
</style>
</head>

<body>

<h2>Pattern Table (Video Style)</h2>

<div class="controls">
  <input type="file" id="csvFile">
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="clearStorage()">Clear</button>
</div>

<div id="tableWrap"></div>

<script>
/* ==========================
   BASIC HELPERS
========================== */
function norm(v){
  if(v==""||v=="**") return "**";
  v=String(v).trim();
  if(!v) return "**";
  return v.length==1 ? "0"+v : v;
}
function palti(v){
  if(v=="**") return "**";
  return v[1]+v[0];
}

/* ==========================
   DATA STORAGE
========================== */
let data = JSON.parse(localStorage.getItem("patternCSV")) || [];

/* ==========================
   CSV LOAD
========================== */
document.getElementById("csvFile").addEventListener("change",e=>{
  let f=e.target.files[0];
  if(!f) return;
  let r=new FileReader();
  r.onload=()=>{
    let rows=r.result.trim().split(/\r?\n/);
    data=rows.map(r=>r.split(",").map(norm));
    save();
    draw();
  };
  r.readAsText(f);
});

/* ==========================
   DRAW TABLE
========================== */
function draw(){
  let html="<table><tbody>";
  for(let i=0;i<data.length;i++){
    html+="<tr>";
    for(let j=0;j<data[i].length;j++){
      let v=data[i][j];
      let cls=v=="**"?"blank":"";
      html+=`<td class="${cls}" contenteditable
             data-r="${i}" data-c="${j}">${v}</td>`;
    }
    html+="</tr>";
  }
  html+="</tbody></table>";
  document.getElementById("tableWrap").innerHTML=html;
  bindEdit();
  applyPatterns();
}

/* ==========================
   EDIT HANDLING
========================== */
function bindEdit(){
  document.querySelectorAll("td[contenteditable]").forEach(td=>{
    td.onblur=()=>{
      let r=+td.dataset.r;
      let c=+td.dataset.c;
      data[r][c]=norm(td.innerText);
      save();
      draw();
    };
  });
}

/* ==========================
   SAVE
========================== */
function save(){
  localStorage.setItem("patternCSV",JSON.stringify(data));
}

/* ==========================
   CLEAR
========================== */
function clearStorage(){
  if(confirm("Clear all data?")){
    localStorage.removeItem("patternCSV");
    data=[];
    draw();
  }
}

/* ==========================
   CSV EXPORT
========================== */
function exportCSV(){
  let csv=data.map(r=>r.join(",")).join("\n");
  let b=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="pattern.csv";
  a.click();
}

/* ==========================
   PATTERN ENGINE (VIDEO STYLE)
========================== */
function applyPatterns(){
  let cells=document.querySelectorAll("td");
  cells.forEach(c=>{
    c.classList.remove("circle","line-vert","line-diag");
  });

  let recentRows=3; // video jaisa base
  if(data.length<recentRows+1) return;

  for(let c=0;c<data[0].length;c++){
    let last=[];
    for(let r=data.length-recentRows;r<data.length;r++){
      last.push(data[r][c]);
    }

    for(let r=0;r<data.length-recentRows;r++){
      let ok=true;
      for(let k=0;k<recentRows;k++){
        if(data[r+k][c]!=last[k]) ok=false;
      }
      if(ok){
        for(let k=0;k<recentRows;k++){
          mark(r+k,c,k);
        }
      }
    }
  }
}

function mark(r,c,k){
  let td=document.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
  if(!td) return;
  if(k==0) td.classList.add("circle");
  if(k>0) td.classList.add("line-vert");
}

/* ==========================
   INIT
========================== */
if(data.length==0){
  data=[
    ["01","12","23","**"],
    ["02","21","32","**"],
    ["03","12","23","**"],
    ["04","21","32","**"]
  ];
  save();
}
draw();
</script>

</body>
</html>
